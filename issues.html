<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YANA — Issues Viewer</title>
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  .navbar { display:flex; align-items:center; justify-content:space-between; padding:12px 20px; background: var(--card); border-bottom:1px solid var(--border); }
  .navbar h2 { color: var(--action); margin:0; }
  .profile { display:flex; align-items:center; gap:12px; }
  .profile-pic { background: var(--action); color:#fff; font-weight:bold; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; }

  .container { padding:20px; }
  table { width:100%; border-collapse:collapse; margin-top:12px; background: rgba(255,255,255,0.05); border-radius: var(--radius); overflow:hidden; }
  th, td { padding:8px; font-size:14px; border-bottom:1px solid rgba(255,255,255,0.1); }
  th { background-color: var(--action); color:#fff; text-align:left; }
  td { color: var(--text); }
  .filters { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px; align-items:center; }
  .filters input, .filters select { padding:6px 10px; border-radius: var(--radius); border:1px solid var(--border); background: var(--bg2); color: var(--text); }
  .filters button { padding:6px 12px; border-radius: var(--radius); border:none; background: var(--action); color:#fff; cursor:pointer; }
  .pagination { display:flex; gap:6px; margin-top:12px; align-items:center; }
  .pagination button { padding:4px 10px; border-radius: var(--radius); border:1px solid var(--border); background: var(--bg2); color: var(--text); cursor:pointer; }
  .pagination button.active { background: var(--action); color:#fff; }

  /* Highlight rows */
  .highlight-issue-created { background: rgba(255,0,0,0.2); }
  .highlight-issue-resolved { background: rgba(0,255,0,0.2); }
  .highlight-state-change { background: rgba(0,0,255,0.2); }
</style>
</head>
<body>
<div class="navbar">
  <h2>⚡ YANA Issues Viewer</h2>
  <div class="profile"><div class="profile-pic">A</div></div>
</div>

<div class="container">
  <h1>🛠 Issues Viewer</h1>
  <p class="muted">View all issues and their resolutions.</p>

  <div class="filters">
    <label>Filter Action:</label>
    <select id="issueFilter">
      <option value="all">All</option>
      <option value="issue-created">Issue Created</option>
      <option value="issue-resolved">Issue Resolved</option>
      <option value="state-change">State Change</option>
    </select>

    <label>Search by Asset ID:</label>
    <input type="text" id="searchInput" placeholder="e.g. SCOOTY001">

    <label>Start Date:</label>
    <input type="date" id="startDate">
    <label>End Date:</label>
    <input type="date" id="endDate">

    <button id="exportBtn">⬇ Export CSV</button>
  </div>

  <table id="issuesTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>Action Type</th>
        <th>Item Type</th>
        <th>Item ID</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
const tbody = document.querySelector("#issuesTable tbody");
const paginationEl = document.getElementById("pagination");
let allLogs = [], userRole = "", userEmail = "";
const itemsPerPage = 10;
let currentPage = 1;

function normalizeName(name) {
  return name ? name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ') : "-";
}

function formatAction(log) {
  if(log.action === "state-change") return { type: "State-Change", details: log.newState };
  if(log.action === "issue-created") return { type: "Issue-Created", details: log.issue };
  if(log.action === "issue-resolved") return { type: "Issue-Resolved", details: log.issue };
  return { type: log.action, details: "" };
}

function getItemType(log) {
  if(log.action.startsWith("issue")) return "Scooty/Battery";
  if(log.type) return log.type === "scooty_master" ? "Scooty" : "Battery";
  return "-";
}

function filterLogs() {
  const filter = document.getElementById("issueFilter").value;
  const searchText = document.getElementById("searchInput").value.trim().toLowerCase();
  const start = document.getElementById("startDate").value ? new Date(document.getElementById("startDate").value) : null;
  const end = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value) : null;

  return allLogs.filter(log => {
    if(userRole === "captain" && log.captainInCharge !== userEmail) return false; // only captain's assets
    if(filter !== "all" && filter !== log.action) return false;
    if(searchText && !(log.itemId||"").toLowerCase().includes(searchText)) return false;
    if(start && log.timestamp?.toDate() < start) return false;
    if(end && log.timestamp?.toDate() > end) return false;
    return true;
  });
}

function renderLogsPage(page=1) {
  const filtered = filterLogs();
  currentPage = page;
  const startIndex = (page-1)*itemsPerPage;
  const pageItems = filtered.slice(startIndex, startIndex + itemsPerPage);

  tbody.innerHTML = "";
  pageItems.forEach(log => {
    let userName = log.admin || log.user || log.email || "-";
    userName = normalizeName(userName);

    const act = formatAction(log);
    const itemType = getItemType(log);

    const tr = document.createElement("tr");
    if(act.type === "Issue-Created") tr.classList.add("highlight-issue-created");
    if(act.type === "Issue-Resolved") tr.classList.add("highlight-issue-resolved");
    if(act.type === "State-Change") tr.classList.add("highlight-state-change");

    tr.innerHTML = `
      <td>${log.timestamp?.toDate().toLocaleString() || "-"}</td>
      <td>${userName}</td>
      <td>${act.type}</td>
      <td>${itemType}</td>
      <td>${log.itemId || "-"}</td>
      <td>${act.details}</td>
    `;
    tbody.appendChild(tr);
  });

  renderPagination(filtered.length);
}

function renderPagination(totalItems) {
  paginationEl.innerHTML = "";
  const totalPages = Math.ceil(totalItems/itemsPerPage);
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement("button");
    btn.innerText = i;
    if(i===currentPage) btn.classList.add("active");
    btn.onclick = () => renderLogsPage(i);
    paginationEl.appendChild(btn);
  }
}

document.getElementById("issueFilter").addEventListener("change", () => renderLogsPage(1));
document.getElementById("searchInput").addEventListener("input", () => renderLogsPage(1));
document.getElementById("startDate").addEventListener("change", () => renderLogsPage(1));
document.getElementById("endDate").addEventListener("change", () => renderLogsPage(1));

document.getElementById("exportBtn").addEventListener("click", () => {
  const logs = filterLogs();
  if(!logs.length){ alert("⚠️ No issues to export."); return; }
  const headers = ["Time","User","Action Type","Item Type","Item ID","Details"];
  const rows = logs.map(log => {
    let userName = log.admin || log.user || log.email || "-";
    userName = normalizeName(userName);
    const act = formatAction(log);
    const itemType = getItemType(log);
    return [log.timestamp?.toDate().toLocaleString()||"-", userName, act.type, itemType, log.itemId||"-", act.details];
  });
  let csvContent = "data:text/csv;charset=utf-8," 
    + headers.join(",") + "\n"
    + rows.map(r => r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const link = document.createElement("a");
  link.setAttribute("href", encodeURI(csvContent));
  link.setAttribute("download","issues_export.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

// Firebase Auth & Load
auth.onAuthStateChanged(async user=>{
  if(!user) { location.href="admin-signin.html"; return; }
  const doc = await db.collection("users").doc(user.email).get();
  if(!doc.exists || !["admin","captain"].includes(doc.data().role)) { alert("❌ Not authorized"); location.href="index.html"; return; }

  userRole = doc.data().role;
  userEmail = user.email;
  document.querySelector(".profile-pic").innerText = (doc.data().name ? doc.data().name[0] : user.email[0]).toUpperCase();

  db.collection("issues").orderBy("timestamp","desc").onSnapshot(snapshot=>{
    allLogs = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
    renderLogsPage(1);
  });
});
</script>
</body>
</html>
