<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Maintenance</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Futura-inspired sleek UI */
    body { background: #121212; color: #E0E0E0; font-family: "Segoe UI", sans-serif; }
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #1F1F1F; }
    .navbar h2 { color: #4FC3F7; margin: 0; }
    .profile-pic { background: #4FC3F7; color: #000; width: 36px; height: 36px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:16px; }
    .container { padding: 20px; }
    h1 { margin-bottom: 12px; color: #4FC3F7; }
    input[type="text"] { padding: 8px 12px; border-radius: var(--radius); border: 1px solid #333; background: #1F1F1F; color: #E0E0E0; margin-bottom: 12px; width: 100%; max-width: 400px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th { background: #4FC3F7; color: #000; padding: 10px; text-align: left; }
    td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    tr.overdue { background: rgba(255,0,0,0.1); }
    .pagination { margin-top: 12px; display: flex; gap: 6px; }
    .pagination button { padding: 6px 10px; border: none; border-radius: 4px; background: #333; color: #E0E0E0; cursor: pointer; transition: 0.2s; }
    .pagination button.active { background: #4FC3F7; color: #000; }
    .btn { background: #4FC3F7; color: #000; padding: 8px 12px; border:none; border-radius:4px; cursor:pointer; margin-top:10px; }
    .btn:hover { background: #29B6F6; }
  </style>
</head>
<body>

  <div class="navbar">
    <h2>⚡ YANA Admin</h2>
    <div class="profile-pic" id="adminInitial">A</div>
  </div>

  <div class="container">
    <h1>Vehicle Maintenance</h1>
    <input type="text" id="searchInput" placeholder="Search by Asset ID or Type">
    <table id="maintTable">
      <thead>
        <tr>
          <th>Asset ID</th>
          <th>Type</th>
          <th>Last Assigned</th>
          <th>Last Returned</th>
          <th>Days Used</th>
          <th>Last Maintenance</th>
          <th>Next Maintenance</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination" id="pagination"></div>
    <button class="btn" id="exportCSV">Export CSV</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const tableBody = document.querySelector("#maintTable tbody");
    const searchInput = document.getElementById("searchInput");
    const paginationDiv = document.getElementById("pagination");
    const exportBtn = document.getElementById("exportCSV");
    const rowsPerPage = 10;
    let allAssets = [];

    // Capitalize helper
    function normalize(str) { 
      if(!str) return "-";
      return str.split(" ").map(w => w[0].toUpperCase()+w.slice(1).toLowerCase()).join(" "); 
    }

    // Date formatting
    function formatDate(ts) { return ts ? new Date(ts).toLocaleDateString() : "-"; }

    auth.onAuthStateChanged(async user => {
      if(!user) return location.href="admin-signin.html";
      const doc = await db.collection("users").doc(user.email).get();
      if(!doc.exists || doc.data().role!=="admin") return location.href="index.html";
      document.getElementById("adminInitial").innerText = (doc.data().name[0]||"A").toUpperCase();

      loadData();
    });

    async function loadData() {
      const snapshot = await db.collection("scooty_master").get();
      const batterySnap = await db.collection("battery_master").get();

      allAssets = [];
      snapshot.docs.forEach(d => allAssets.push({assetId:d.id,type:"Scooty",...d.data()}));
      batterySnap.docs.forEach(d => allAssets.push({assetId:d.id,type:"Battery",...d.data()}));

      renderTable(1);
    }

    function computeDaysUsed(asset){
      if(!asset.firstAssign || !asset.lastReturn) return 0;
      const diff = new Date(asset.lastReturn) - new Date(asset.firstAssign);
      return Math.floor(diff/(1000*60*60*24));
    }

    function computeNextMaintenance(asset){
      const daysUsed = computeDaysUsed(asset);
      if(daysUsed<=30) return asset.lastMaintenance || null;
      return asset.lastMaintenance ? new Date(new Date(asset.lastMaintenance).getTime() + daysUsed*24*60*60*1000) : null;
    }

    function renderTable(page){
      const filter = searchInput.value.toLowerCase();
      const filtered = allAssets.filter(a => 
        (a.assetId.toLowerCase().includes(filter) || (a.type||"").toLowerCase().includes(filter))
      );

      filtered.forEach(a=>{
        a.daysUsed = computeDaysUsed(a);
        a.nextMaintenance = computeNextMaintenance(a);
      });

      const dueAssets = filtered.filter(a => a.nextMaintenance && new Date() >= a.nextMaintenance);

      const totalPages = Math.ceil(dueAssets.length/rowsPerPage);
      const start = (page-1)*rowsPerPage;
      const end = start+rowsPerPage;
      const pageItems = dueAssets.slice(start,end);

      tableBody.innerHTML = "";
      pageItems.forEach(a=>{
        const tr = document.createElement("tr");
        if(a.nextMaintenance && new Date() >= a.nextMaintenance) tr.classList.add("overdue");
        tr.innerHTML = `
          <td>${a.assetId}</td>
          <td>${normalize(a.type)}</td>
          <td>${formatDate(a.lastAssigned)}</td>
          <td>${formatDate(a.lastReturn)}</td>
          <td>${a.daysUsed}</td>
          <td>${formatDate(a.lastMaintenance)}</td>
          <td>${formatDate(a.nextMaintenance)}</td>
        `;
        tableBody.appendChild(tr);
      });

      // Pagination buttons
      paginationDiv.innerHTML = "";
      for(let i=1;i<=totalPages;i++){
        const btn = document.createElement("button");
        btn.innerText = i;
        if(i===page) btn.classList.add("active");
        btn.addEventListener("click",()=>renderTable(i));
        paginationDiv.appendChild(btn);
      }
    }

    searchInput.addEventListener("input",()=>renderTable(1));

    // Export CSV
    exportBtn.addEventListener("click",()=>{
      const headers = ["Asset ID","Type","Last Assigned","Last Returned","Days Used","Last Maintenance","Next Maintenance"];
      const rows = Array.from(tableBody.querySelectorAll("tr")).map(tr=>{
        return Array.from(tr.children).map(td=>td.innerText);
      });
      let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
      csvContent += rows.map(r=>r.map(v=>`"${v}"`).join(",")).join("\n");

      const link = document.createElement("a");
      link.setAttribute("href",encodeURI(csvContent));
      link.setAttribute("download","maintenance_due.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
