<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Vehicle Maintenance</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#0a0a0a; color:#fff; }
    .navbar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#111; }
    .navbar h2 { color:#00eaff; margin:0; }
    .profile-pic { width:32px; height:32px; border-radius:50%; background:#00eaff; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#000; }

    .container { padding:16px; max-width:1200px; margin:auto; }
    h1 { margin-bottom:12px; color:#00eaff; }

    .top-controls { display:flex; justify-content:space-between; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
    .top-controls input { flex:1; min-width:200px; padding:8px; border-radius:6px; border:1px solid rgba(0,234,255,0.5); background:#111; color:#fff; }
    .btn { background:#00eaff; color:#000; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; transition:0.2s; }
    .btn:hover { background:#00c7e0; }

    .table-container { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; table-layout:fixed; }
    th, td { padding:8px; font-size:14px; border-bottom:1px solid rgba(0,234,255,0.2); word-break:break-word; }
    th { background:#00eaff; color:#000; }
    tbody tr:hover { background: rgba(0,234,255,0.1); }
    tbody tr.overdue { background: rgba(255,0,0,0.2); }

    .pagination { display:flex; justify-content:center; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .page-btn { padding:6px 10px; border-radius:4px; border:none; background:#00eaff; color:#000; cursor:pointer; transition:0.2s; }
    .page-btn.active { background:#00c7e0; font-weight:bold; }
    .page-btn:hover:not(.active) { background:#00c7e0; }
  </style>
</head>
<body>
  <div class="navbar">
    <h2>YANA Admin</h2>
    <div class="profile-pic">A</div>
  </div>

  <div class="container">
    <h1>Vehicle Maintenance Due</h1>

    <div class="top-controls">
      <button id="exportBtn" class="btn">⬇ Export CSV</button>
      <input type="text" id="searchInput" placeholder="Search by Vehicle ID or Assigned Name">
    </div>

    <div class="table-container">
      <table id="maintTable">
        <thead>
          <tr>
            <th>Vehicle ID</th>
            <th>Assigned To</th>
            <th>Days Used</th>
            <th>Next Maintenance Day</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const tableBody = document.querySelector("#maintTable tbody");
    const searchInput = document.getElementById("searchInput");
    const paginationDiv = document.getElementById("pagination");
    const exportBtn = document.getElementById("exportBtn");

    let allVehicles = [];
    let filteredVehicles = [];
    const rowsPerPage = 10;
    let currentPage = 1;

    function normalizeName(name) {
      return name.split(" ").map(n => n.charAt(0).toUpperCase() + n.slice(1).toLowerCase()).join(" ");
    }

    function renderTable() {
      tableBody.innerHTML = "";
      const start = (currentPage-1)*rowsPerPage;
      const pageItems = filteredVehicles.slice(start,start+rowsPerPage);
      const today = new Date();
      pageItems.forEach(v=>{
        const tr = document.createElement("tr");
        if(v.nextMaintenance && v.nextMaintenance < today) tr.classList.add("overdue");
        tr.innerHTML = `
          <td>${v.id}</td>
          <td>${normalizeName(v.assignedName||"-")}</td>
          <td>${v.daysUsed}</td>
          <td>${v.nextMaintenance ? v.nextMaintenance.toLocaleDateString() : "-"}</td>
        `;
        tableBody.appendChild(tr);
      });
      renderPagination();
    }

    function renderPagination() {
      paginationDiv.innerHTML = "";
      const totalPages = Math.ceil(filteredVehicles.length/rowsPerPage);
      for(let i=1;i<=totalPages;i++){
        const btn = document.createElement("button");
        btn.className="page-btn"+(i===currentPage?" active":"");
        btn.innerText=i;
        btn.addEventListener("click",()=>{ currentPage=i; renderTable(); });
        paginationDiv.appendChild(btn);
      }
    }

    function filterAndRender() {
      const term = searchInput.value.toLowerCase();
      filteredVehicles = allVehicles.filter(v=> v.id.toLowerCase().includes(term) || (v.assignedName||"").toLowerCase().includes(term));
      currentPage = 1;
      renderTable();
    }

    searchInput.addEventListener("input", filterAndRender);

    exportBtn.addEventListener("click",()=>{
      if(!filteredVehicles.length){ alert("No data to export"); return; }
      const headers = ["Vehicle ID","Assigned To","Days Used","Next Maintenance Day"];
      const rows = filteredVehicles.map(v=>[v.id,normalizeName(v.assignedName||"-"),v.daysUsed,v.nextMaintenance ? v.nextMaintenance.toLocaleDateString() : "-"]);
      let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(r=>r.map(c=>`"${c}"`).join(",")).join("\n");
      const link = document.createElement("a");
      link.href = encodeURI(csvContent);
      link.download = "maintenance_due.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    auth.onAuthStateChanged(async user=>{
      if(!user) return location.href="admin-signin.html";
      const doc = await db.collection("users").doc(user.email).get();
      if(!doc.exists || doc.data().role!=="admin"){ alert("Not admin"); return location.href="index.html"; }

      const scootySnap = await db.collection("scooty_master").get();
      const batterySnap = await db.collection("battery_master").get();
      allVehicles = [];

      function calculateNextMaintenance(firstAssign,lastReturn,lastMaintenance){
        const daysUsed = Math.floor((lastReturn - firstAssign)/(1000*60*60*24));
        const nextMaintenance = daysUsed>30 ? new Date(lastMaintenance.getTime() + daysUsed*24*60*60*1000) : null;
        return {daysUsed,nextMaintenance};
      }

      for(const doc of scootySnap.docs){
        const data = doc.data();
        if(!data.firstAssign || !data.lastReturn) continue;
        const lastMaintenance = data.lastMaintenance ? data.lastMaintenance.toDate() : new Date(data.firstAssign.toDate());
        const {daysUsed,nextMaintenance} = calculateNextMaintenance(data.firstAssign.toDate(),data.lastReturn.toDate(),lastMaintenance);
        if(nextMaintenance){
          allVehicles.push({
            id: doc.id,
            assignedName: data.assignedName||"-",
            daysUsed,
            nextMaintenance
          });
        }
      }

      for(const doc of batterySnap.docs){
        const data = doc.data();
        if(!data.firstAssign || !data.lastReturn) continue;
        const lastMaintenance = data.lastMaintenance ? data.lastMaintenance.toDate() : new Date(data.firstAssign.toDate());
        const {daysUsed,nextMaintenance} = calculateNextMaintenance(data.firstAssign.toDate(),data.lastReturn.toDate(),lastMaintenance);
        if(nextMaintenance){
          allVehicles.push({
            id: doc.id,
            assignedName: data.assignedName||"-",
            daysUsed,
            nextMaintenance
          });
        }
      }

      filteredVehicles = [...allVehicles];
      renderTable();
    });
  </script>
</body>
</html>
