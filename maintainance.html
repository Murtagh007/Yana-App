<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA â€” Maintenance</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .navbar { display:flex; align-items:center; justify-content:space-between; padding:12px 20px; background:#000; color:#fff; }
    .profile-pic { width:36px; height:36px; border-radius:50%; background:#00eaff; color:#000; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:16px; }
    .container { padding:20px; }
    h1 { color:#00eaff; margin-bottom:12px; }
    .search-bar { margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .search-bar input, .search-bar button, .search-bar input[type="date"] { padding:8px; border-radius:6px; border:1px solid #ccc; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th { background:#00eaff; color:#000; padding:8px; text-align:left; }
    td { border-bottom:1px solid rgba(255,255,255,0.1); padding:8px; font-size:14px; }
    tr:hover { background:rgba(0,234,255,0.05); }
    .pagination { margin-top:12px; display:flex; gap:8px; }
    .pagination button { padding:6px 12px; border-radius:6px; border:none; cursor:pointer; background:#00eaff; color:#000; font-weight:bold; }
    .pagination button:disabled { background:rgba(0,234,255,0.3); cursor:default; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <h2>YANA Admin</h2>
    <div class="profile-pic" id="profilePic">A</div>
  </div>

  <div class="container">
    <h1>Maintenance Due Vehicles</h1>

    <!-- Search and Export -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by Vehicle ID or Assigned To">
      <input type="date" id="fromDate">
      <input type="date" id="toDate">
      <button id="exportBtn">Export CSV</button>
    </div>

    <!-- Table -->
    <table>
      <thead>
        <tr>
          <th>Vehicle ID</th>
          <th>Assigned To</th>
          <th>Last Return</th>
          <th>Days Used</th>
          <th>Last Maintenance</th>
          <th>Next Maintenance</th>
        </tr>
      </thead>
      <tbody id="maintTableBody"></tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination">
      <button id="prevBtn">Previous</button>
      <span id="pageInfo"></span>
      <button id="nextBtn">Next</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const tableBody = document.getElementById("maintTableBody");
    const searchInput = document.getElementById("searchInput");
    const fromDateInput = document.getElementById("fromDate");
    const toDateInput = document.getElementById("toDate");
    const exportBtn = document.getElementById("exportBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInfo = document.getElementById("pageInfo");

    const pageSize = 10;
    let currentPage = 1;
    let allVehicles = [];

    function normalizeName(name) {
      if(!name) return "-";
      return name.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(" ");
    }

    auth.onAuthStateChanged(async user => {
      if(!user) return location.href="admin-signin.html";
      const doc = await db.collection("users").doc(user.email).get();
      if(!doc.exists || doc.data().role !== "admin") return location.href="index.html";
      document.getElementById("profilePic").innerText = (doc.data().name || user.email[0]).charAt(0).toUpperCase();
      loadMaintenance();
    });

    async function loadMaintenance() {
      const snapshot = await db.collection("scooty_master").get();
      const temp = [];
      for(const doc of snapshot.docs) {
        const data = doc.data();
        // Only if Last Return exists
        if(!data.lastReturn) continue;

        const daysUsed = Math.floor((data.lastReturn.toDate() - data.firstAssign.toDate()) / (1000*60*60*24));
        if(daysUsed <= 30) continue;

        const nextMaintenance = new Date(data.lastMaintenance.toDate());
        nextMaintenance.setDate(nextMaintenance.getDate() + daysUsed);

        const assignedName = data.assignedName ? normalizeName(data.assignedName) : "-";

        temp.push({
          id: doc.id,
          assignedTo: assignedName,
          lastReturn: data.lastReturn.toDate(),
          daysUsed,
          lastMaintenance: data.lastMaintenance.toDate(),
          nextMaintenance
        });
      }
      allVehicles = temp;
      currentPage = 1;
      renderTable();
    }

    function filterData() {
      let filtered = allVehicles;

      const term = searchInput.value.trim().toLowerCase();
      if(term) filtered = filtered.filter(v => v.id.toLowerCase().includes(term) || (v.assignedTo||"").toLowerCase().includes(term));

      const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
      const toDate = toDateInput.value ? new Date(toDateInput.value) : null;
      if(fromDate) filtered = filtered.filter(v => v.nextMaintenance >= fromDate);
      if(toDate) filtered = filtered.filter(v => v.nextMaintenance <= toDate);

      return filtered;
    }

    function renderTable() {
      const filtered = filterData();
      const totalPages = Math.ceil(filtered.length / pageSize);
      currentPage = Math.min(currentPage, totalPages) || 1;
      const start = (currentPage-1)*pageSize;
      const pageData = filtered.slice(start, start+pageSize);

      tableBody.innerHTML = "";
      for(const v of pageData) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.id}</td>
          <td>${v.assignedTo}</td>
          <td>${v.lastReturn.toLocaleDateString()}</td>
          <td>${v.daysUsed}</td>
          <td>${v.lastMaintenance.toLocaleDateString()}</td>
          <td>${v.nextMaintenance.toLocaleDateString()}</td>
        `;
        tableBody.appendChild(tr);
      }

      pageInfo.innerText = `Page ${currentPage} of ${totalPages || 1}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }

    searchInput.addEventListener("input", () => { currentPage=1; renderTable(); });
    fromDateInput.addEventListener("change", () => { currentPage=1; renderTable(); });
    toDateInput.addEventListener("change", () => { currentPage=1; renderTable(); });
    prevBtn.addEventListener("click", () => { if(currentPage>1){ currentPage--; renderTable(); } });
    nextBtn.addEventListener("click", () => { currentPage++; renderTable(); });

    exportBtn.addEventListener("click", () => {
      const filtered = filterData();
      if(!filtered.length){ alert("No data to export."); return; }
      const headers = ["Vehicle ID","Assigned To","Last Return","Days Used","Last Maintenance","Next Maintenance"];
      const rows = filtered.map(v=>[
        v.id,
        v.assignedTo,
        v.lastReturn.toLocaleDateString(),
        v.daysUsed,
        v.lastMaintenance.toLocaleDateString(),
        v.nextMaintenance.toLocaleDateString()
      ]);
      let csv = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(r=>r.map(c=>`"${c}"`).join(",")).join("\n");
      const link = document.createElement("a");
      link.href = encodeURI(csv);
      link.download = "maintenance.csv";
      link.click();
    });
  </script>
</body>
</html>
