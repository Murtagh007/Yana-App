<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>YANA — Maintenance Due</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Reset & basic */
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: 'Segoe UI', sans-serif; background:#0a0a0a; color:#fff; }

    /* Navbar */
    .navbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 16px;
      background:#0a0a0a;
    }
    .navbar h2 { color:#00eaff; font-size:18px; }
    .profile-pic {
      width:36px; height:36px; border-radius:50%;
      background:#00eaff; color:#000;
      display:flex; justify-content:center; align-items:center;
      font-weight:bold; font-size:16px;
    }

    /* Container */
    .container { padding:16px; }
    h1 { font-size:20px; color:#00eaff; margin-bottom:12px; }

    /* Search */
    .search-container { margin-bottom:12px; }
    .search-container input {
      width:100%;
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      color:#fff;
    }

    /* Table */
    .table-container {
      overflow-x:auto;
      border-radius:8px;
      margin-top:12px;
    }
    table {
      width:100%;
      border-collapse: collapse;
      min-width:600px;
    }
    th, td {
      padding:10px;
      text-align:left;
      font-size:14px;
      border-bottom:1px solid rgba(255,255,255,0.1);
    }
    th { background:#00eaff; color:#000; }
    tr:hover { background: rgba(0,234,255,0.1); }

    /* Buttons */
    .btn { 
      background:#00eaff; color:#000; border:none; 
      padding:8px 12px; border-radius:6px; cursor:pointer; margin-top:12px;
    }
    .btn:disabled { background:rgba(0,234,255,0.3); cursor:not-allowed; }

    /* Pagination */
    .pagination {
      display:flex; justify-content:center; gap:8px; margin-top:16px; flex-wrap:wrap;
    }
    .pagination button {
      background:#00eaff; color:#000; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;
    }
    .pagination button.disabled { background: rgba(0,234,255,0.3); cursor:not-allowed; }

    /* Mobile first adjustments done; larger screens tweaks */
    @media(min-width:768px){
      h1 { font-size:24px; }
      th, td { font-size:15px; padding:12px; }
    }
    @media(min-width:1024px){
      .container { padding:24px 48px; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <h2>YANA Admin</h2>
    <div class="profile-pic">A</div>
  </div>

  <div class="container">
    <h1>Maintenance Due Vehicles</h1>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Search by Vehicle ID or Assigned Name">
    </div>

    <div class="table-container">
      <table id="maintTable">
        <thead>
          <tr>
            <th>Vehicle ID</th>
            <th>Assigned To</th>
            <th>Days Used</th>
            <th>Next Maintenance Day</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="pagination" id="pagination"></div>
    <button id="exportBtn" class="btn">⬇ Export CSV</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const tableBody = document.querySelector("#maintTable tbody");
    const searchInput = document.getElementById("searchInput");
    const paginationDiv = document.getElementById("pagination");
    const exportBtn = document.getElementById("exportBtn");
    const pageSize = 10;
    let allVehicles = [];

    function normalizeName(name) {
      return name.split(" ").map(n => n.charAt(0).toUpperCase() + n.slice(1).toLowerCase()).join(" ");
    }

    // Fetch vehicles and calculate maintenance due
    async function loadVehicles() {
      const snapshot = await db.collection("scooty_master").get();
      allVehicles = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        if(data.firstAssign && data.lastReturn && data.lastMaintenance) {
          const first = data.firstAssign.toDate();
          const lastReturn = data.lastReturn.toDate();
          const lastMaint = data.lastMaintenance.toDate();
          const daysUsed = Math.floor((lastReturn - first)/(1000*60*60*24));
          let nextMaint = null;
          if(daysUsed > 30) {
            nextMaint = new Date(lastMaint);
            nextMaint.setDate(nextMaint.getDate() + daysUsed);
          }
          if(nextMaint) allVehicles.push({
            id: doc.id,
            assignedName: normalizeName(data.assignedName || "-"),
            daysUsed,
            nextMaint: nextMaint.toLocaleDateString()
          });
        }
      });

      renderTable(1);
    }

    function renderTable(page) {
      const filtered = allVehicles.filter(v => v.id.toLowerCase().includes(searchInput.value.toLowerCase())
        || v.assignedName.toLowerCase().includes(searchInput.value.toLowerCase()));
      const totalPages = Math.ceil(filtered.length/pageSize);
      tableBody.innerHTML = "";
      const start = (page-1)*pageSize;
      const end = start+pageSize;
      filtered.slice(start,end).forEach(v=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.id}</td>
          <td>${v.assignedName}</td>
          <td>${v.daysUsed}</td>
          <td>${v.nextMaint}</td>
        `;
        tableBody.appendChild(tr);
      });

      // Pagination
      paginationDiv.innerHTML = "";
      for(let i=1;i<=totalPages;i++){
        const btn = document.createElement("button");
        btn.textContent = i;
        if(i===page) btn.classList.add("disabled");
        btn.addEventListener("click",()=>renderTable(i));
        paginationDiv.appendChild(btn);
      }
    }

    searchInput.addEventListener("input",()=>renderTable(1));

    exportBtn.addEventListener("click",()=>{
      const rows = [["Vehicle ID","Assigned To","Days Used","Next Maintenance"]];
      allVehicles.forEach(v=>{
        rows.push([v.id,v.assignedName,v.daysUsed,v.nextMaint]);
      });
      let csvContent = "data:text/csv;charset=utf-8," + rows.map(r=>r.join(",")).join("\n");
      const link = document.createElement("a");
      link.href = encodeURI(csvContent);
      link.download = "maintenance_due.csv";
      link.click();
    });

    loadVehicles();
  </script>
</body>
</html>
