<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA ‚Äî Seeder</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    #log {
      background:#000;
      color:#0f0;
      padding:10px;
      margin-top:20px;
      border-radius:6px;
      height:200px;
      overflow:auto;
      white-space: pre-wrap;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <button class="btn secondary" onclick="window.location.href='admin-dashboard.html'">‚¨Ö Dashboard</button>
    <span id="adminEmail"></span>
    <button class="btn secondary" id="logoutBtn">Logout</button>
  </div>

  <!-- Seeder UI -->
  <div class="container">
    <h1>üöÄ YANA Seeder</h1>
    <p class="muted">Seeds <code>scooty_master</code> and <code>battery_master</code> into Firestore.</p>
    <button class="btn" id="startBtn">Start Seeding</button>

    <div id="log"></div>
  </div>

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const logBox = document.getElementById("log");
    const log = msg => logBox.textContent += msg + "\n";

    // Auth check (must be admin)
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = "admin-signin.html";
        return;
      }
      document.getElementById("adminEmail").innerText = "üë§ " + user.email;

      const doc = await db.collection("users").doc(user.email).get();
      if (!doc.exists || doc.data().role !== "admin") {
        alert("‚ùå Not an admin.");
        window.location.href = "index.html";
        return;
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => auth.signOut());

    // Seeder function
    document.getElementById("startBtn").addEventListener("click", async () => {
      log("üîë Seeding as admin: " + auth.currentUser.email);

      async function seedCollection(filename, collectionName) {
        log(`\nüìÇ Seeding ${collectionName} from ${filename}...`);
        try {
          const res = await fetch(filename);
          if(!res.ok) throw new Error(`Failed to fetch ${filename}`);
          const text = await res.text();
          const ids = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);

          let success = 0, fail = 0;
          for(const id of ids){
            try {
              await db.collection(collectionName).doc(id).set({
                state: "active",
                status: "returned",
                lastAssignedTo: null,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge: true });
              log(`‚úÖ Added ${collectionName}: ${id}`);
              success++;
            } catch(err){
              log(`‚ùå Failed ${id}: ${err.message}`);
              fail++;
            }
          }
          log(`‚úîÔ∏è Completed ${collectionName}. Success: ${success}, Failed: ${fail}`);
        } catch(err){
          log(`‚ùå Seeding ${collectionName} failed: ${err.message}`);
        }
      }

      await seedCollection("scootyid.txt", "scooty_master");
      await seedCollection("batteryid.txt", "battery_master");

      log("\nüéâ Seeding completed.");
    });
  </script>
</body>
</html>

