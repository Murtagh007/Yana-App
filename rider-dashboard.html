<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Rider Dashboard</title>

  <!-- Styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root {
      --bg: #0a0f12;
      --card: rgba(255,255,255,0.1);
      --border: rgba(255,255,255,0.2);
      --action: #00eaff;
      --text: #eaf4f8;
      --radius: 16px;
    }
    body {
      margin:0;
      font-family:'Inter',sans-serif;
      background: linear-gradient(270deg,var(--bg),#141a1f,var(--bg));
      background-size: 600% 600%;
      animation: gradientShift 20s ease infinite;
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    @keyframes gradientShift{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* Navbar */
    .navbar{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 20px;background:var(--card);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(6px);position:sticky;top:0;z-index:1000;
    }
    .navbar h2{margin:0;color:var(--action);font-size:1.2rem;}
    .profile{position:relative;display:flex;align-items:center;cursor:pointer;}
    .profile-pic{width:36px;height:36px;border-radius:50%;background:var(--action);
      color:#000;font-weight:bold;display:flex;align-items:center;justify-content:center;}
    .dropdown{display:none;position:absolute;top:44px;right:0;background:var(--card);
      border-radius:var(--radius);padding:4px 0;min-width:100px;}
    .dropdown button{width:100%;background:none;border:none;color:var(--text);
      padding:8px 12px;cursor:pointer;text-align:left;}
    .profile:hover .dropdown{display:block;}

    /* Container/Card */
    .container{flex:1;display:flex;justify-content:center;align-items:flex-start;padding:10px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
      padding:24px;width:100%;max-width:420px;box-shadow:0 4px 20px rgba(0,234,255,0.3);
      text-align:center;backdrop-filter:blur(10px);margin-bottom:80px;}

    h1{font-size:24px;font-weight:700;color:var(--action);margin-bottom:16px;}
    .timer-box{background:rgba(255,255,255,0.05);border:1px solid var(--border);
      border-radius:var(--radius);padding:12px 16px;margin-bottom:12px;}
    .timer-title{font-weight:600;margin-bottom:4px;font-size:1rem;color:#fff;}
    .timer-value{font-size:1.8rem;font-weight:700;margin-bottom:4px;}

    /* Buttons */
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0;}
    .btn{flex:1;min-width:120px;padding:12px;border:none;border-radius:var(--radius);
      font-size:1rem;font-weight:600;cursor:pointer;transition:0.2s;background:var(--action);color:#000;
      display:flex;align-items:center;justify-content:center;gap:6px;}
    .btn:hover{background:#00c8e0;}
    .btn.secondary{background:transparent;color:var(--action);border:2px solid var(--action);}
    .btn.secondary:hover{background:rgba(0,234,255,0.1);}

    /* Scooty/Battery info */
    .info-box{background:rgba(255,255,255,0.05);border:1px solid var(--border);
      border-radius:var(--radius);padding:12px;margin:6px 0;display:flex;justify-content:space-between;
      font-weight:500;color:var(--text);box-shadow: inset 0 0 6px rgba(0,0,0,0.5);}

    /* Bottom Nav */
    .bottom-nav{position:fixed;bottom:0;left:0;width:100%;display:flex;
      justify-content:space-around;background:var(--card);padding:8px 0;border-top:1px solid var(--border);
      backdrop-filter:blur(10px);z-index:1000;}
    .nav-btn{flex:1;text-align:center;color:var(--text);cursor:pointer;font-size:0.9rem;display:flex;flex-direction:column;align-items:center;gap:2px;}
    .nav-btn.active{color:var(--action);}

    /* Toast */
    #toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
      background:rgba(0,234,255,0.9);color:#000;padding:10px 16px;border-radius:6px;
      display:none;font-weight:bold;z-index:1000;}
    @media(max-width:480px){.timer-value{font-size:1.5rem;}.btn{font-size:0.9rem;padding:10px;}
      h1{font-size:20px;}}
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <h2>⚡ YANA Rider</h2>
    <div class="profile">
      <div class="profile-pic">R</div>
      <div class="dropdown">
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <!-- Main Card -->
  <div class="container">
    <div class="card">
      <h1>Dashboard</h1>

      <!-- Timers -->
      <div class="timer-box">
        <div class="timer-title">Working Hours</div>
        <div class="timer-value" id="workingTimer">00:00:00</div>
        <div class="timer-title">Total Break</div>
        <div class="timer-value" id="breakTimer">00:00:00</div>
        <div class="timer-title" id="shiftInfo">Assigned Shift: 09:00 - 18:00</div>
      </div>

      <!-- Punch / Break Buttons -->
      <div class="btn-row">
        <button class="btn" id="punchBtn"><i class="fa-solid fa-user-check"></i> Punch In</button>
        <button class="btn" id="breakBtn"><i class="fa-solid fa-bed"></i> Start Break</button>
      </div>

      <!-- Scooty / Battery Info -->
      <div class="info-box">Scooty: <span id="currentScooty">Loading...</span></div>
      <div class="info-box">Battery: <span id="currentBattery">Loading...</span></div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-btn" id="scannerBtn"><i class="fa-solid fa-qrcode"></i><span>Scanner</span></div>
    <div class="nav-btn" id="issueBtn"><i class="fa-solid fa-triangle-exclamation"></i><span>Issues</span></div>
    <div class="nav-btn" id="attendanceBtn"><i class="fa-solid fa-user-check"></i><span>Attendance</span></div>
    <div class="nav-btn" id="logsBtn"><i class="fa-solid fa-file-lines"></i><span>Logs</span></div>
  </div>

  <div id="toast"></div>

  <script>
    // ------------------ Toast ------------------
    const toast = msg => {
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.style.display = "block";
      setTimeout(()=>t.style.display="none",3000);
    };

    // ------------------ Geolocation ------------------
    function getCurrentPositionAsync() {
      return new Promise((resolve,reject)=>{
        if(!navigator.geolocation) reject("Geolocation not supported");
        navigator.geolocation.getCurrentPosition(resolve,reject);
      });
    }

    // ------------------ Global State ------------------
    const email = new URLSearchParams(window.location.search).get("email");
    if(!email){toast("❌ Not signed in!");window.location.href="rider-signin.html";}

    let session = {
      punchedIn:false,
      punchInTime:null,
      workingSeconds:0,
      onBreak:false,
      breakStartTime:null,
      totalBreakSeconds:0,
      lastReset:null
    };
    let workingInterval=null;
    let breakInterval=null;
    let punchProcessing=false;
    let breakProcessing=false;

    const workingTimer = document.getElementById("workingTimer");
    const breakTimer = document.getElementById("breakTimer");
    const punchBtn = document.getElementById("punchBtn");
    const breakBtn = document.getElementById("breakBtn");

    // ------------------ Firestore References ------------------
    const todayKey = new Date().toISOString().split("T")[0];
    const sessionDocRef = db.collection("attendance").doc(`${email}_${todayKey}`);

    // ------------------ Load Existing Session ------------------
    async function loadSession(){
      // Local storage first
      const local = localStorage.getItem("attendanceSession");
      if(local) session = JSON.parse(local);

      // Firestore sync
      const doc = await sessionDocRef.get();
      if(doc.exists) session = {...session, ...doc.data()};

      updateUI();
      startIntervals();
    }

    // ------------------ UI Update ------------------
    function updateUI(){
      workingTimer.innerText = secondsToHMS(session.workingSeconds);
      breakTimer.innerText = secondsToHMS(session.totalBreakSeconds);
      punchBtn.innerText = session.punchedIn ? "Punch Out" : "Punch In";
      breakBtn.innerText = session.onBreak ? "Stop Break" : "Start Break";
    }

    function secondsToHMS(sec){
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }
    function pad(n){return n.toString().padStart(2,"0");}

    // ------------------ Intervals ------------------
    function startIntervals(){
      if(workingInterval) clearInterval(workingInterval);
      if(breakInterval) clearInterval(breakInterval);

      if(session.punchedIn && !session.onBreak){
        workingInterval = setInterval(()=>{
          session.workingSeconds++;
          workingTimer.innerText = secondsToHMS(session.workingSeconds);
          localStorage.setItem("attendanceSession",JSON.stringify(session));
        },1000);
      }

      if(session.onBreak){
        breakInterval = setInterval(()=>{
          session.totalBreakSeconds++;
          breakTimer.innerText = secondsToHMS(session.totalBreakSeconds);
          localStorage.setItem("attendanceSession",JSON.stringify(session));
        },1000);
      }
    }

    // ------------------ Punch In/Out ------------------
    punchBtn.addEventListener("click",async()=>{
      if(punchProcessing) return;
      punchProcessing=true;

      try{
        const pos = await getCurrentPositionAsync();
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        // Check geofence (replace with your Firestore locations)
        const locsSnap = await db.collection("locations").get();
        let inside=false;
        locsSnap.forEach(doc=>{
          const d=doc.data();
          const distance=getDistanceFromLatLonInKm(lat,lng,d.lat,d.lng)*1000;
          if(distance<=d.radius) inside=true;
        });
        if(!inside){toast("❌ Outside allowed area"); punchProcessing=false; return;}

        if(!session.punchedIn){
          session.punchedIn=true;
          session.punchInTime=Date.now();
          toast("✅ Punched In");
        }else{
          session.punchedIn=false;
          toast("✅ Punched Out");
        }

        // Stop any intervals and restart correctly
        startIntervals();
        updateUI();

        // Store locally and sync Firestore
        localStorage.setItem("attendanceSession",JSON.stringify(session));
        await sessionDocRef.set(session,{merge:true});

      }catch(err){toast("❌ "+err.message);}finally{punchProcessing=false;}
    });

    // ------------------ Break Button ------------------
    breakBtn.addEventListener("click",async()=>{
      if(breakProcessing) return;
      breakProcessing=true;

      try{
        if(!session.punchedIn){toast("❌ Punch in first"); breakProcessing=false; return;}

        if(!session.onBreak){
          session.onBreak=true;
          session.breakStartTime=Date.now();
          toast("⏸ Break Started");
        }else{
          session.onBreak=false;
          // Calculate duration
          const dur = Math.floor((Date.now()-session.breakStartTime)/1000);
          session.totalBreakSeconds+=dur;
          session.breakStartTime=null;
          toast("▶️ Break Ended");
        }

        // Stop/start intervals accordingly
        startIntervals();
        updateUI();

        localStorage.setItem("attendanceSession",JSON.stringify(session));
        await sessionDocRef.set(session,{merge:true});

      }catch(err){toast("❌ "+err.message);}finally{breakProcessing=false;}
    });

    // ------------------ Helper: Distance ------------------
    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2){
      const R=6371;
      const dLat=(lat2-lat1)*Math.PI/180;
      const dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }

    // ------------------ Navigation ------------------
    document.getElementById("scannerBtn").addEventListener("click",()=>window.location.href=`scanner.html?email=${email}`);
    document.getElementById("issueBtn").addEventListener("click",()=>window.location.href=`issue.html?email=${email}`);
    document.getElementById("attendanceBtn").addEventListener("click",()=>window.location.href=`rider-dashboard.html?email=${email}`);
    document.getElementById("logsBtn").addEventListener("click",()=>window.location.href=`rider-logs.html?email=${email}`);

    document.getElementById("logoutBtn").addEventListener("click",()=>firebase.auth().signOut().then(()=>window.location.href="rider-signin.html"));

    // ------------------ Load Data ------------------
    loadSession();
  </script>

</body>
</html>
