<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YANA — Rider Dashboard (Real-time, robust)</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="firebase-config.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --bg:#071014; --card: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.12);
  --accent:#00eaff; --text:#eaf4f8; --r:16px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,system-ui,Arial; background:linear-gradient(180deg,#061014,#0d1720);
  color:var(--text); min-height:100vh; display:flex; flex-direction:column;
}
.header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.header h1{margin:0;font-size:1.05rem;color:var(--accent)}
.container{padding:14px;display:flex;justify-content:center}
.card{width:92vw;max-width:520px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
border-radius:var(--r);padding:18px;border:1px solid var(--border);box-shadow:0 8px 30px rgba(0,0,0,0.5)}
.title{font-size:1.2rem;color:var(--accent);margin-bottom:8px}
.riderName{font-size:1rem;margin-bottom:14px}
.timerRow{display:flex;gap:12px;flex-wrap:wrap}
.block{flex:1;min-width:140px;background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid var(--border);text-align:center}
.block .label{font-size:0.9rem;color:#bcd; margin-bottom:6px}
.block .value{font-size:1.6rem;font-weight:700}
.controls{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
.btn{flex:1;min-width:140px;padding:12px;border-radius:12px;border:none;font-weight:700;cursor:pointer;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;gap:8px}
.btn.secondary{background:transparent;color:var(--accent);border:2px solid var(--accent)}
.info{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
.info .pill{flex:1;min-width:140px;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);text-align:center}
.bottomNav{position:fixed;left:0;right:0;bottom:0;padding:10px;background:var(--card);display:flex;justify-content:space-around;border-top:1px solid var(--border)}
.navBtn{color:var(--text);text-align:center;font-size:0.9rem;cursor:pointer;display:flex;flex-direction:column;align-items:center}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:76px;background:var(--accent);color:#000;padding:10px 14px;border-radius:8px;display:none;z-index:50}
.small{font-size:0.85rem;color:#bcd;margin-top:6px}
@media(max-width:420px){.btn{min-width:120px;padding:10px}.block .value{font-size:1.3rem}}
</style>
</head>
<body>

<div class="header">
  <h1>⚡ YANA Rider</h1>
  <div style="display:flex;align-items:center;gap:12px">
    <div id="profilePic" style="width:36px;height:36px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center">R</div>
    <button id="logoutBtn" class="btn secondary" style="padding:8px 10px;font-size:0.8rem">Logout</button>
  </div>
</div>

<div class="container">
  <div class="card" role="main">
    <div class="title">Rider Dashboard</div>
    <div id="riderName" class="riderName">Loading...</div>

    <div class="timerRow">
      <div class="block">
        <div class="label">Working Hours</div>
        <div id="workValue" class="value">00:00:00</div>
        <div id="workSmall" class="small">--</div>
      </div>
      <div class="block">
        <div class="label">Break Time</div>
        <div id="breakValue" class="value">00:00:00</div>
        <div id="breakSmall" class="small">--</div>
      </div>
    </div>

    <div class="controls">
      <button id="punchBtn" class="btn"><i class="fa-solid fa-clock"></i><span id="punchLabel">Punch In</span></button>
      <button id="breakBtn" class="btn secondary"><i class="fa-solid fa-coffee"></i><span id="breakLabel">Start Break</span></button>
    </div>

    <div class="info">
      <div class="pill">Scooty: <strong id="scooty">Loading...</strong></div>
      <div class="pill">Battery: <strong id="battery">Loading...</strong></div>
    </div>

    <div class="small" style="margin-top:12px" id="statusLine">Status: --</div>
  </div>
</div>

<div class="bottomNav">
  <div class="navBtn" id="navScanner"><i class="fa-solid fa-qrcode"></i><div>Scanner</div></div>
  <div class="navBtn" id="navIssues"><i class="fa-solid fa-triangle-exclamation"></i><div>Issues</div></div>
  <div class="navBtn" id="navAttendance"><i class="fa-solid fa-user-check"></i><div>Attendance</div></div>
  <div class="navBtn" id="navLogs"><i class="fa-solid fa-file-lines"></i><div>Logs</div></div>
</div>

<div id="toast" class="toast"></div>

<script>
(async function init(){ 
  if(typeof firebase === 'undefined' || typeof db === 'undefined'){
    alert("Firebase not configured. Make sure firebase-config.js sets `db = firebase.firestore();`");
    return;
  }

  try { await firebase.firestore().enablePersistence(); } catch(e) {}

  const toast = (msg)=>{ const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2500); };
  const pad=(n)=>String(n).padStart(2,'0');
  const format=(s)=>`${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`;

  function getCurrentPositionAsync(opts={enableHighAccuracy:true,timeout:10000}) {
    return new Promise((res,rej)=>{ if(!navigator.geolocation) return rej(new Error("Geolocation not supported")); navigator.geolocation.getCurrentPosition(res, rej, opts); });
  }
  function haversineMeters(lat1,lon1,lat2,lon2){
    const R=6371e3,toRad=(v)=>v*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  const email = new URLSearchParams(window.location.search).get('email');
  if(!email){ toast("Not signed in"); setTimeout(()=>location.href='rider-signin.html',800); return; }

  let processingPunch=false, processingBreak=false;

  // --------------------------
  // Punch toggle (geolocation only for Punch IN)
  // --------------------------
  async function doPunchToggle(){
    if(processingPunch) return;
    processingPunch=true;
    try{
      if(!localState.punchedIn){
        let pos=null;
        try{ pos = await getCurrentPositionAsync(); } catch(err){ toast("Location failed"); processingPunch=false; return; }
        const lat=pos.coords.latitude,lng=pos.coords.longitude;
        const locs = await db.collection('locations').get();
        let allowed=false; locs.forEach(doc=>{ const d=doc.data(); if(haversineMeters(lat,lng,d.lat,d.lng)<= (d.radius||0)+8) allowed=true; });
        if(!allowed){ toast("Outside allowed area"); processingPunch=false; return; }
        // proceed with punch in logic
      } else {
        // punch out (no geolocation)
      }
    }finally{ processingPunch=false; }
  }

  // --------------------------
  // Break toggle (no geolocation)
  // --------------------------
  async function doBreakToggle(){
    if(processingBreak) return;
    processingBreak=true;
    try{
      if(!localState.punchedIn){ toast("Punch in first"); return; }
      if(!localState.onBreak){
        // start break logic
      } else {
        // stop break logic
      }
    }finally{ processingBreak=false; }
  }

  // Attach buttons
  document.getElementById('punchBtn').addEventListener('click', doPunchToggle);
  document.getElementById('breakBtn').addEventListener('click', doBreakToggle);
})();
</script>
</body>
</html>
