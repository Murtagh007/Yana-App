<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YANA — Rider Dashboard (Real-time, robust)</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="firebase-config.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --bg:#071014; --card: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.12);
  --accent:#00eaff; --text:#eaf4f8; --r:16px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,system-ui,Arial; background:linear-gradient(180deg,#061014,#0d1720);
  color:var(--text); min-height:100vh; display:flex; flex-direction:column;
}
.header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.header h1{margin:0;font-size:1.05rem;color:var(--accent)}
.container{padding:14px;display:flex;justify-content:center}
.card{width:92vw;max-width:520px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
border-radius:var(--r);padding:18px;border:1px solid var(--border);box-shadow:0 8px 30px rgba(0,0,0,0.5)}
.title{font-size:1.2rem;color:var(--accent);margin-bottom:8px}
.riderName{font-size:1rem;margin-bottom:14px}
.timerRow{display:flex;gap:12px;flex-wrap:wrap}
.block{flex:1;min-width:140px;background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid var(--border);text-align:center}
.block .label{font-size:0.9rem;color:#bcd; margin-bottom:6px}
.block .value{font-size:1.6rem;font-weight:700}
.controls{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
.btn{flex:1;min-width:140px;padding:12px;border-radius:12px;border:none;font-weight:700;cursor:pointer;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;gap:8px}
.btn.secondary{background:transparent;color:var(--accent);border:2px solid var(--accent)}
.info{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
.info .pill{flex:1;min-width:140px;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);text-align:center}
.bottomNav{position:fixed;left:0;right:0;bottom:0;padding:10px;background:var(--card);display:flex;justify-content:space-around;border-top:1px solid var(--border)}
.navBtn{color:var(--text);text-align:center;font-size:0.9rem;cursor:pointer;display:flex;flex-direction:column;align-items:center}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:76px;background:var(--accent);color:#000;padding:10px 14px;border-radius:8px;display:none;z-index:50}
.small{font-size:0.85rem;color:#bcd;margin-top:6px}
@media(max-width:420px){.btn{min-width:120px;padding:10px}.block .value{font-size:1.3rem}}
</style>
</head>
<body>

<div class="header">
  <h1>⚡ YANA Rider</h1>
  <div style="display:flex;align-items:center;gap:12px">
    <div id="profilePic" style="width:36px;height:36px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center">R</div>
    <button id="logoutBtn" class="btn secondary" style="padding:8px 10px;font-size:0.8rem">Logout</button>
  </div>
</div>

<div class="container">
  <div class="card" role="main">
    <div class="title">Rider Dashboard</div>
    <div id="riderName" class="riderName">Loading...</div>

    <div class="timerRow">
      <div class="block">
        <div class="label">Working Hours</div>
        <div id="workValue" class="value">00:00:00</div>
        <div id="workSmall" class="small">--</div>
      </div>
      <div class="block">
        <div class="label">Break Time</div>
        <div id="breakValue" class="value">00:00:00</div>
        <div id="breakSmall" class="small">--</div>
      </div>
    </div>

    <div class="controls">
      <button id="punchBtn" class="btn"><i class="fa-solid fa-clock"></i><span id="punchLabel">Punch In</span></button>
      <button id="breakBtn" class="btn secondary"><i class="fa-solid fa-coffee"></i><span id="breakLabel">Start Break</span></button>
    </div>

    <div class="info">
      <div class="pill">Scooty: <strong id="scooty">Loading...</strong></div>
      <div class="pill">Battery: <strong id="battery">Loading...</strong></div>
    </div>

    <div class="small" style="margin-top:12px" id="statusLine">Status: --</div>
  </div>
</div>

<div class="bottomNav">
  <div class="navBtn" id="navScanner"><i class="fa-solid fa-qrcode"></i><div>Scanner</div></div>
  <div class="navBtn" id="navIssues"><i class="fa-solid fa-triangle-exclamation"></i><div>Issues</div></div>
  <div class="navBtn" id="navAttendance"><i class="fa-solid fa-user-check"></i><div>Attendance</div></div>
  <div class="navBtn" id="navLogs"><i class="fa-solid fa-file-lines"></i><div>Logs</div></div>
</div>

<div id="toast" class="toast"></div>

<script>
(async function init(){ 
  if(typeof firebase === 'undefined' || typeof db === 'undefined'){
    alert("Firebase not configured. Make sure firebase-config.js sets `db = firebase.firestore();`");
    return;
  }

  try { await firebase.firestore().enablePersistence(); } catch(e) { }

  const toast = (msg)=>{ const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2500); };
  const pad=(n)=>String(n).padStart(2,'0');
  const format=(s)=>`${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`;

  function getCurrentPositionAsync(opts={enableHighAccuracy:true,timeout:10000}) {
    return new Promise((res,rej)=>{
      if(!navigator.geolocation) return rej(new Error("Geolocation not supported"));
      navigator.geolocation.getCurrentPosition(res, rej, opts);
    });
  }

  const email = new URLSearchParams(window.location.search).get('email');
  if(!email){ toast("Not signed in"); setTimeout(()=>location.href='rider-signin.html',800); return; }

  const todayKey = ()=> new Date().toISOString().slice(0,10);
  let currentDay = todayKey();
  const stateDocRef = ()=> db.collection('attendance').doc(`${email}_${currentDay}_state`);
  const eventsColRef = ()=> db.collection('attendance').doc(`${email}_${currentDay}_state`).collection('events');

  const LS_KEY = `attendance_session_${email}_${currentDay}`;
  let localState = {
    punchedIn:false,
    punchInTime:null,
    workingSeconds:0,
    onBreak:false,
    breakStartTime:null,
    totalBreakSeconds:0,
    lastUpdated: null
  };

  let workTicker = null, breakTicker = null;
  let processingPunch=false, processingBreak=false;
  let unsubStateListener = null;

  const workValue = document.getElementById('workValue');
  const breakValue = document.getElementById('breakValue');
  const punchBtn = document.getElementById('punchBtn');
  const breakBtn = document.getElementById('breakBtn');
  const punchLabel = document.getElementById('punchLabel') || null;
  const breakLabel = document.getElementById('breakLabel') || null;
  const riderNameEl = document.getElementById('riderName');
  const scootyEl = document.getElementById('scooty');
  const batteryEl = document.getElementById('battery');
  const statusLine = document.getElementById('statusLine');

  function saveLocal(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(localState)); }catch(e){} }
  function loadLocal(){ try{ const raw = localStorage.getItem(LS_KEY); if(raw){ const obj = JSON.parse(raw); if(typeof obj === 'object' && obj!==null) localState = {...localState,...obj}; } }catch(e){} }

  function rotateDayIfNeeded(){
    const nowDay = todayKey();
    if(nowDay !== currentDay){
      currentDay = nowDay;
      localState = {punchedIn:false,punchInTime:null,workingSeconds:0,onBreak:false,breakStartTime:null,totalBreakSeconds:0,lastUpdated:null};
      saveLocal();
      attachStateListener();
      updateUI();
      stopTickers();
    }
  }
  setInterval(rotateDayIfNeeded, 60*1000);

  async function attachStateListener(){
    if(unsubStateListener) { unsubStateListener(); unsubStateListener=null; }
    const ref = stateDocRef();
    unsubStateListener = ref.onSnapshot(snap=>{
      if(!snap.exists) return;
      const data = snap.data();
      const s = {};
      s.punchedIn = !!data.punchedIn;
      s.workingSeconds = Number(data.workingSeconds || 0);
      s.onBreak = !!data.onBreak;
      s.totalBreakSeconds = Number(data.totalBreakSeconds || 0);
      s.lastUpdated = data.lastUpdated ? data.lastUpdated.toMillis() : Date.now();
      s.punchInTime = data.punchInTime ? data.punchInTime.toMillis() : null;
      s.breakStartTime = data.breakStartTime ? data.breakStartTime.toMillis() : null;

      if(localState.lastUpdated && localState.lastUpdated > s.lastUpdated){ } 
      else { localState = {...localState, ...s}; saveLocal(); startTickers(); updateUI(); }
    }, err=>{ console.warn("state listener error",err); });
  }

  async function logEvent(type, extra={}){ try{ const event = {type, rider: email, clientTs: Date.now(), serverTs: firebase.firestore.FieldValue.serverTimestamp(), ...extra}; await eventsColRef().add(event); }catch(e){ console.error("logEvent failed",e); } }

  async function writeStateToServer(){
    try{
      const payload = {
        punchedIn: !!localState.punchedIn,
        workingSeconds: Number(localState.workingSeconds || 0),
        onBreak: !!localState.onBreak,
        totalBreakSeconds: Number(localState.totalBreakSeconds || 0),
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      };
      if(localState.punchInTime) payload.punchInTime = firebase.firestore.Timestamp.fromMillis(localState.punchInTime); else payload.punchInTime = null;
      if(localState.breakStartTime) payload.breakStartTime = firebase.firestore.Timestamp.fromMillis(localState.breakStartTime); else payload.breakStartTime = null;
      await stateDocRef().set(payload, {merge:true});
    }catch(e){ console.error("writeStateToServer failed:", e); }
  }

  let bgSyncHandle = null;
  function startBackgroundSync(){ if(bgSyncHandle) return; bgSyncHandle = setInterval(async ()=>{ await writeStateToServer(); }, 6000); }
  function stopBackgroundSync(){ if(bgSyncHandle){ clearInterval(bgSyncHandle); bgSyncHandle=null; } }

  function updateUI(){
    workValue.innerText = format(localState.workingSeconds);
    breakValue.innerText = format(localState.totalBreakSeconds);
    punchLabel.innerText = localState.punchedIn ? 'Punch Out' : 'Punch In';
    breakLabel.innerText = localState.onBreak ? 'Stop Break' : 'Start Break';
    statusLine.innerText = `Status: ${localState.onBreak ? 'On Break' : (localState.punchedIn ? 'Working' : 'Idle')}`;
  }

  function stopTickers(){ if(workTicker){ clearInterval(workTicker); workTicker=null; } if(breakTicker){ clearInterval(breakTicker); breakTicker=null; } }
  function startTickers(){
    stopTickers();
    if(localState.punchedIn && !localState.onBreak){ workTicker=setInterval(()=>{ localState.workingSeconds+=1; localState.lastUpdated=Date.now(); saveLocal(); workValue.innerText=format(localState.workingSeconds); },1000); }
    if(localState.onBreak){ breakTicker=setInterval(()=>{ localState.totalBreakSeconds+=1; localState.lastUpdated=Date.now(); saveLocal(); breakValue.innerText=format(localState.totalBreakSeconds); },1000); }
  }

  async function doPunchToggle(){
    if(processingPunch) return; processingPunch=true;
    try{
      let pos=null;
      try{ pos=await getCurrentPositionAsync({enableHighAccuracy:true,timeout:10000}); }catch(err){ toast("Location failed: "+(err.message||err)); processingPunch=false; return; }
      const lat=pos.coords.latitude, lng=pos.coords.longitude;
      if(!localState.punchedIn){
        localState.punchedIn=true; localState.punchInTime=Date.now(); localState.lastUpdated=Date.now();
        startTickers(); updateUI(); saveLocal();
        await logEvent('punchIn',{lat,lng});
        await writeStateToServer();
        toast("✅ Punched In");
      } else {
        stopTickers(); localState.punchedIn=false; localState.punchInTime=null; localState.onBreak=false; localState.breakStartTime=null; localState.lastUpdated=Date.now();
        updateUI(); saveLocal();
        await logEvent('punchOut',{workingSeconds: localState.workingSeconds});
        await writeStateToServer();
        toast("✅ Punched Out");
      }
    }catch(e){ console.error("doPunchToggle error",e); toast("Action failed"); } finally{ processingPunch=false; }
  }

  async function doBreakToggle(){
    if(processingBreak) return; processingBreak=true;
    try{
      if(!localState.punchedIn){ toast("Punch in first"); processingBreak=false; return; }
      if(!localState.onBreak){
        stopTickers();
        localState.onBreak=true; localState.breakStartTime=Date.now(); localState.lastUpdated=Date.now();
        startTickers(); updateUI(); saveLocal();
        await logEvent('startBreak',{});
        await writeStateToServer();
        toast("⏸ Break started");
      } else {
        stopTickers();
        const breakStart=localState.breakStartTime||Date.now();
        const dur=Math.floor((Date.now()-breakStart)/1000);
        localState.totalBreakSeconds+=dur;
        localState.onBreak=false; localState.breakStartTime=null; localState.lastUpdated=Date.now();
        startTickers(); updateUI(); saveLocal();
        await logEvent('stopBreak',{durationSec:dur});
        await writeStateToServer();
        toast("▶ Break ended");
      }
    }catch(e){ console.error("doBreakToggle error",e); toast("Action failed"); } finally{ processingBreak=false; }
  }

  punchBtn.addEventListener('click', doPunchToggle);
  breakBtn.addEventListener('click', doBreakToggle);
  document.getElementById('logoutBtn').addEventListener('click',()=>{ localStorage.removeItem(LS_KEY); firebase.auth().signOut(); location.href='rider-signin.html'; });

  // ==== Fetch rider info, scooty, battery ====
  try{
    const userDoc = await db.collection('users').doc(email).get();
    if(userDoc.exists){
      const userData = userDoc.data();
      riderNameEl.innerText = userData.name || 'Unknown Rider';

      if(userData.scooterId){
        const scootyDoc = await db.collection('scooty_master').doc(userData.scooterId).get();
        scootyEl.innerText = scootyDoc.exists ? scootyDoc.id : 'Unknown';
      } else scootyEl.innerText = 'No scooty assigned';

      if(userData.batteryId){
        const batteryDoc = await db.collection('battery_master').doc(userData.batteryId).get();
        batteryEl.innerText = batteryDoc.exists ? batteryDoc.id : 'No battery assigned';
      } else batteryEl.innerText = 'No battery assigned';
    }
  }catch(e){ console.error("Fetching rider info failed:",e); }

  // ==== Bottom navigation ====
  document.getElementById('navScanner').addEventListener('click',()=>{ location.href=`scanner.html?email=${email}`; });
  document.getElementById('navIssues').addEventListener('click',()=>{ location.href=`issues.html?email=${email}`; });
  document.getElementById('navAttendance').addEventListener('click',()=>{ location.href=`rider-dashboard.html?email=${email}`; });
  document.getElementById('navLogs').addEventListener('click',()=>{ location.href=`rider-logs.html?email=${email}`; });

  // =============================================

  startBackgroundSync();
  loadLocal();
  attachStateListener();
  startTickers();
  updateUI();

})();
</script>

</body>
</html>
