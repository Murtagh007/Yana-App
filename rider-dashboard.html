<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>YANA — Rider Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --bg:#0a0f12;
  --card:rgba(255,255,255,0.12);
  --border:rgba(255,255,255,0.2);
  --action:#00eaff;
  --text:#eaf4f8;
  --radius:20px;
}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background: linear-gradient(270deg,var(--bg),#141a1f,var(--bg));
  background-size: 600% 600%;
  animation: gradientShift 20s ease infinite;
  color: var(--text);
  display:flex;
  flex-direction:column;
  min-height:100vh;
}
@keyframes gradientShift{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
/* Navbar */
.navbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 20px;
  height:60px;
  background: var(--card);
  border-bottom:1px solid var(--border);
  backdrop-filter: blur(6px);
  position: sticky;
  top:0;
  z-index:1000;
}
.navbar h2{
  margin:0;
  color: var(--action);
  font-size:1.3rem;
}
.profile{
  position:relative;
  display:flex;
  align-items:center;
  cursor:pointer;
}
.profile-pic{
  width:44px;
  height:44px;
  border-radius:50%;
  background: var(--action);
  color:#000;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.1rem;
}
.dropdown{
  display:none;
  position:absolute;
  top:50px;
  right:0;
  background: var(--card);
  border-radius: var(--radius);
  padding:4px 0;
  min-width:120px;
}
.dropdown button{
  width:100%;
  background:none;
  border:none;
  color: var(--text);
  padding:10px 12px;
  cursor:pointer;
  text-align:left;
}
.profile:hover .dropdown { display:block; }

/* Container */
.container{
  flex:1;
  padding:16px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* Card */
.card{
  width:90vw;
  max-width:420px;
  background: var(--card);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding:24px;
  box-shadow:0 6px 25px rgba(0,234,255,0.35);
  backdrop-filter:blur(12px);
  display:flex;
  flex-direction:column;
  align-items:center;
  margin-bottom:16px;
}
h1{
  font-size:28px;
  font-weight:700;
  color:var(--action);
  margin-bottom:16px;
}
#riderName{
  font-size:22px;
  font-weight:600;
  color:#fff;
  margin-bottom:20px;
}
.status-box{
  background: rgba(255,255,255,0.05);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding:12px 16px;
  width:100%;
  text-align:center;
  font-weight:500;
  color:var(--text);
  margin-bottom:10px;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.5);
}
.timer-value{
  font-size:2rem;
  font-weight:700;
  margin-bottom:8px;
}
.actions{
  display:flex;
  flex-direction:row;
  gap:12px;
  justify-content:center;
  margin-top:12px;
  flex-wrap:wrap;
}
.btn{
  flex:1;
  min-width:130px;
  padding:14px;
  border:none;
  border-radius: var(--radius);
  font-size:1rem;
  font-weight:600;
  cursor:pointer;
  transition:0.2s;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  background: var(--action);
  color:#000;
}
.btn:hover{background:#00c8e0;}
.btn.secondary{
  background:transparent;
  color: var(--action);
  border:2px solid var(--action);
}
.btn.secondary:hover{background:rgba(0,234,255,0.1);}

/* Bottom Nav */
.bottom-nav{
  display:flex;
  justify-content:space-around;
  align-items:center;
  position:fixed;
  bottom:0;
  width:100%;
  height:60px;
  background: var(--card);
  border-top:1px solid var(--border);
  backdrop-filter: blur(6px);
  padding:4px 0;
  z-index:1000;
}
.bottom-nav button{
  font-size:1.3rem;
  flex-direction:column;
  display:flex;
  align-items:center;
  gap:2px;
  background:none;
  border:none;
  color:var(--text);
  cursor:pointer;
}
.bottom-nav button.active{color: var(--action);}
#toast{
  position:fixed;
  bottom:70px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,234,255,0.9);
  color:#000;
  padding:10px 16px;
  border-radius:8px;
  display:none;
  font-weight:bold;
  z-index:2000;
}
@media(max-width:480px){
  .status-box{font-size:0.95rem;}
  h1{font-size:24px;}
  #riderName{font-size:20px;}
  .navbar h2{font-size:1rem;}
}
</style>
</head>
<body>

<div class="navbar">
  <h2>⚡ YANA Rider</h2>
  <div class="profile">
    <div class="profile-pic">R</div>
    <div class="dropdown">
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">
    <h1>Rider Dashboard</h1>
    <div id="riderName">Loading...</div>

    <div class="status-box">
      <div>Working Hours</div>
      <div class="timer-value" id="timerDisplay">00:00:00</div>
    </div>
    <div class="status-box">
      <div>Break Time</div>
      <div class="timer-value" id="breakDisplay">00:00:00</div>
    </div>
    <div class="status-box">
      Assigned Scooty: <span id="currentScooty">Loading...</span><br>
      Assigned Battery: <span id="currentBattery">Loading...</span>
    </div>

    <div class="actions">
      <button class="btn" id="punchBtn"><i class="fa-solid fa-user-check"></i> Punch In</button>
      <button class="btn" id="breakBtn"><i class="fa-solid fa-coffee"></i> Start Break</button>
    </div>

    <div class="actions" style="margin-top:12px;">
      <button class="btn secondary" id="scannerBtn"><i class="fa-solid fa-qrcode"></i> Scanner</button>
      <button class="btn secondary" id="issueBtn"><i class="fa-solid fa-triangle-exclamation"></i> Issues</button>
      <button class="btn secondary" id="logsBtn"><i class="fa-solid fa-file-lines"></i> Logs</button>
    </div>
  </div>
</div>

<div class="bottom-nav">
  <button id="navHome" class="active"><i class="fa-solid fa-house"></i><span>Home</span></button>
  <button id="navScanner"><i class="fa-solid fa-qrcode"></i><span>Scanner</span></button>
  <button id="navIssue"><i class="fa-solid fa-triangle-exclamation"></i><span>Issues</span></button>
  <button id="navAttendance"><i class="fa-solid fa-user-check"></i><span>Attendance</span></button>
  <button id="navLogs"><i class="fa-solid fa-file-lines"></i><span>Logs</span></button>
</div>

<div id="toast"></div>

<script>
const toast = msg => {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",3000);
};

const params = new URLSearchParams(window.location.search);
const email = params.get("email");
if(!email){ toast("❌ Not signed in!"); window.location.href="rider-signin.html"; }

let punchedIn=false, onBreak=false;
let workSeconds=0, breakSeconds=0;
let workInterval=null, breakInterval=null;
const timerDisplay=document.getElementById("timerDisplay");
const breakDisplay=document.getElementById("breakDisplay");
const punchBtn=document.getElementById("punchBtn");
const breakBtn=document.getElementById("breakBtn");

// Haversine formula
function getDistance(lat1,lon1,lat2,lon2){
  const R=6371; // km
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*1000*c; // meters
}
function secToHMS(sec){
  const h=Math.floor(sec/3600).toString().padStart(2,'0');
  const m=Math.floor((sec%3600)/60).toString().padStart(2,'0');
  const s=(sec%60).toString().padStart(2,'0');
  return `${h}:${m}:${s}`;
}

// Load Rider and session
async function loadRider(){
  const doc=await db.collection("users").doc(email).get();
  if(!doc.exists){ toast("❌ Rider not found"); window.location.href="rider-signup.html"; return;}
  const data=doc.data();
  document.getElementById("riderName").innerText=data.name||"Rider";
  document.getElementById("currentScooty").innerText=data.assignedScooty||"None";
  document.getElementById("currentBattery").innerText=data.assignedBattery||"None";

  const session=data.currentSession||{};
  if(session.punchedIn && session.punchInTime){
    punchedIn=true;
    const punchDate=session.punchInTime.toDate ? session.punchInTime.toDate() : new Date(session.punchInTime);
    workSeconds=Math.floor((new Date()-punchDate)/1000 - (session.totalBreakSeconds||0));
    timerDisplay.textContent=secToHMS(workSeconds);
    workInterval=setInterval(()=>{workSeconds++; timerDisplay.textContent=secToHMS(workSeconds);},1000);
    punchBtn.textContent="Punch Out";
  }

  if(session.onBreak && session.breakStartTime){
    onBreak=true;
    const breakStart=session.breakStartTime.toDate ? session.breakStartTime.toDate() : new Date(session.breakStartTime);
    breakSeconds=Math.floor((new Date()-breakStart)/1000);
    breakDisplay.textContent=secToHMS(breakSeconds);
    breakInterval=setInterval(()=>{breakSeconds++; breakDisplay.textContent=secToHMS(breakSeconds);},1000);
    breakBtn.textContent="End Break";
    clearInterval(workInterval);
  }
}
loadRider();

// --- Punch In/Out
punchBtn.onclick=async()=>{
  if(!navigator.geolocation){toast("❌ Geolocation not supported"); return;}
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude,lng=pos.coords.longitude;
    const locs=await db.collection("locations").get();
    let inside=null;
    locs.forEach(doc=>{const d=doc.data(); if(getDistance(lat,lng,d.lat,d.lng)<=d.radius) inside=d.name;});
    if(!inside){toast("❌ Outside geofence"); return;}
    const userRef=db.collection("users").doc(email);
    const session=(await userRef.get()).data().currentSession||{totalBreakSeconds:0};
    const currentlyIn=session.punchedIn||false;
    if(!currentlyIn){
      await userRef.set({currentSession:{punchedIn:true,punchInTime:firebase.firestore.FieldValue.serverTimestamp(),onBreak:false,breakStartTime:null,totalBreakSeconds:0}},{merge:true});
      punchedIn=true; workSeconds=0;
      clearInterval(workInterval);
      workInterval=setInterval(()=>{workSeconds++; timerDisplay.textContent=secToHMS(workSeconds);},1000);
      punchBtn.textContent="Punch Out";
      toast(`✅ Punched in at ${inside}`);
    } else {
      await userRef.set({currentSession:{punchedIn:false,punchInTime:null,onBreak:false,breakStartTime:null,totalBreakSeconds:0}},{merge:true});
      punchedIn=false; clearInterval(workInterval); clearInterval(breakInterval); workSeconds=0; breakSeconds=0;
      timerDisplay.textContent="00:00:00"; breakDisplay.textContent="00:00:00"; punchBtn.textContent="Punch In"; breakBtn.textContent="Start Break";
      toast("✅ Punched out");
    }
  }, err=>toast("❌ Location error: "+err.message));
};

// --- Break
breakBtn.onclick=async()=>{
  if(!navigator.geolocation){toast("❌ Geolocation not supported"); return;}
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude,lng=pos.coords.longitude;
    const locs=await db.collection("locations").get();
    let inside=null;
    locs.forEach(doc=>{const d=doc.data(); if(getDistance(lat,lng,d.lat,d.lng)<=d.radius) inside=d.name;});
    if(!inside){toast("❌ Outside geofence"); return;}
    const userRef=db.collection("users").doc(email);
    const userDoc=await userRef.get();
    const session=userDoc.data().currentSession||{totalBreakSeconds:0};
    const currentlyOnBreak=session.onBreak||false;

    if(!currentlyOnBreak){
      onBreak=true;
      clearInterval(workInterval);
      breakSeconds=0;
      breakInterval=setInterval(()=>{breakSeconds++; breakDisplay.textContent=secToHMS(breakSeconds);},1000);
      breakBtn.textContent="End Break";
      await userRef.set({...session,onBreak:true,breakStartTime:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      toast(`✅ Break started at ${inside}`);
    } else {
      onBreak=false;
      clearInterval(breakInterval);
      breakBtn.textContent="Start Break";
      const breakStartTime=session.breakStartTime ? session.breakStartTime.toDate() : new Date();
      const totalBreak=(session.totalBreakSeconds||0)+Math.floor((new Date()-breakStartTime)/1000);
      await userRef.set({...session,onBreak:false,breakStartTime:null,totalBreakSeconds:totalBreak},{merge:true});
      workSeconds+=breakSeconds;
      workInterval=setInterval(()=>{workSeconds++; timerDisplay.textContent=secToHMS(workSeconds);},1000);
      toast("✅ Break ended");
    }
  }, err=>toast("❌ Location error: "+err.message));
};

// --- Navigation
document.getElementById("scannerBtn").onclick=()=>window.location.href=`scanner.html?email=${email}`;
document.getElementById("issueBtn").onclick=()=>window.location.href=`issue.html?email=${email}`;
document.getElementById("logsBtn").onclick=()=>window.location.href=`rider-logs.html?email=${email}`;
document.getElementById("navHome").onclick=()=>window.location.href=`rider-dashboard.html?email=${email}`;
document.getElementById("navScanner").onclick=()=>window.location.href=`scanner.html?email=${email}`;
document.getElementById("navIssue").onclick=()=>window.location.href=`issue.html?email=${email}`;
document.getElementById("navAttendance").onclick=()=>window.location.href=`attendance.html?email=${email}`;
document.getElementById("navLogs").onclick=()=>window.location.href=`rider-logs.html?email=${email}`;

// --- Logout
document.getElementById("logoutBtn").onclick=()=>firebase.auth().signOut().then(()=>window.location.href="rider-signin.html");
</script>

</body>
</html>
