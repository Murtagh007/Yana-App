<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rider Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f8f9fa;
      display: flex; flex-direction: column;
      height: 100vh;
    }
    header {
      background: #0066cc;
      color: white;
      text-align: center;
      padding: 1rem;
      font-size: 1.2rem;
    }
    main {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1.2rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    .card h2 { margin: 0 0 0.5rem; font-size: 1.2rem; }
    .timer { font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0; }
    .btn {
      display: inline-block;
      padding: 0.8rem 1.2rem;
      margin: 0.4rem;
      font-size: 1rem;
      border: none; border-radius: 8px;
      cursor: pointer;
      color: white;
    }
    .btn-primary { background: #007bff; }
    .btn-secondary { background: #28a745; }
    .btn:disabled { background: #aaa; cursor: not-allowed; }
    nav {
      display: flex;
      justify-content: space-around;
      background: #fff;
      border-top: 1px solid #ddd;
      padding: 0.6rem 0;
    }
    nav button {
      background: none; border: none;
      font-size: 0.9rem; color: #333;
      cursor: pointer;
    }
    .toast {
      position: fixed;
      bottom: 70px; left: 50%;
      transform: translateX(-50%);
      background: #333; color: #fff;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      display: none;
    }
  </style>
</head>
<body>
  <header>Rider Dashboard</header>
  <main>
    <div class="card">
      <h2>Working Hours</h2>
      <div id="workTimer" class="timer">00:00:00</div>
      <div>Total Break: <span id="breakTimer">00:00:00</span></div>
      <div>Assigned Shift: 9 AM – 6 PM</div>
      <div style="margin-top:1rem;">
        <button id="punchBtn" class="btn btn-primary">Punch In</button>
        <button id="breakBtn" class="btn btn-secondary">Start Break</button>
      </div>
    </div>

    <div class="card">
      <h2>Scooty & Battery</h2>
      <p>Scooty ID: <span id="scootyId">—</span></p>
      <p>Battery ID: <span id="batteryId">—</span></p>
    </div>
  </main>

  <nav>
    <button onclick="goPage('scanner.html')">Scanner</button>
    <button onclick="goPage('issues.html')">Issues</button>
    <button onclick="goPage('attendance.html')">Attendance</button>
    <button onclick="goPage('logs.html')">Logs</button>
  </nav>

  <div id="toast" class="toast"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // ✅ Firebase config (replace with your own)
    var firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_APP.firebaseapp.com",
      projectId: "YOUR_PROJECT",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let processingPunch=false, processingBreak=false;
    let localState = {
      isWorking:false,
      isOnBreak:false,
      punchInTime:null,
      breakStartTime:null,
      totalBreakMs:0,
      lastUpdated:0
    };

    let workTicker=null, breakTicker=null;

    function goPage(url){ window.location.href=url; }

    function showToast(msg){
      const t=document.getElementById("toast");
      t.innerText=msg; t.style.display="block";
      setTimeout(()=>t.style.display="none",2000);
    }

    function fmt(ms){
      let s=Math.floor(ms/1000);
      let h=Math.floor(s/3600); s%=3600;
      let m=Math.floor(s/60); s%=60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function startTickers(){
      stopTickers();
      if(localState.isWorking){
        workTicker=setInterval(()=>{
          let ms=Date.now()-localState.punchInTime-localState.totalBreakMs;
          if(localState.isOnBreak) ms-=(Date.now()-localState.breakStartTime);
          document.getElementById("workTimer").innerText=fmt(ms);
        },1000);
      }
      if(localState.isOnBreak){
        breakTicker=setInterval(()=>{
          let ms=localState.totalBreakMs+(Date.now()-localState.breakStartTime);
          document.getElementById("breakTimer").innerText=fmt(ms);
        },1000);
      } else {
        document.getElementById("breakTimer").innerText=fmt(localState.totalBreakMs);
      }
    }
    function stopTickers(){ if(workTicker)clearInterval(workTicker); if(breakTicker)clearInterval(breakTicker); }

    async function writeStateToServer(){
      await db.collection("attendance").doc("STATE_DOC").set(localState);
    }
    async function logEvent(type){
      await db.collection("attendanceLogs").add({type,time:Date.now()});
    }
    function renderUI(){
      document.getElementById("punchBtn").innerText = localState.isWorking ? "Punch Out":"Punch In";
      document.getElementById("breakBtn").innerText = localState.isOnBreak ? "End Break":"Start Break";
      startTickers();
    }

    // --- Punch In/Out ---
    async function doPunchToggle(){
      if(processingPunch) return;
      processingPunch=true;
      try{
        const btn=document.getElementById("punchBtn");
        btn.disabled=true;
        showToast(localState.isWorking?"Punching out...":"Punching in...");

        // 📍 Only on Punch In
        if(!localState.isWorking){
          let pos = await getCurrentPositionAsync();
          const locs = await db.collection("locations").get();
          let inside=false;
          locs.forEach(doc=>{
            const loc=doc.data();
            if(getDistance(pos.coords.latitude,pos.coords.longitude,loc.lat,loc.lng)<=loc.radius) inside=true;
          });
          if(!inside){ showToast("⛔ Outside geofence!"); return; }
        }

        localState.isWorking=!localState.isWorking;
        localState.isOnBreak=false;
        if(localState.isWorking){ localState.punchInTime=Date.now(); }
        else { localState.punchInTime=null; localState.breakStartTime=null; localState.totalBreakMs=0; }

        stopTickers(); if(localState.isWorking) startTickers();

        await Promise.all([writeStateToServer(), logEvent(localState.isWorking?"punchIn":"punchOut")]);
        renderUI();
        showToast(localState.isWorking?"✅ Punched In":"👋 Punched Out");
      }catch(e){ console.error(e); showToast("⚠️ "+e.message);}
      finally{ document.getElementById("punchBtn").disabled=false; processingPunch=false;}
    }

    // --- Break Start/End ---
    async function doBreakToggle(){
      if(processingBreak) return;
      processingBreak=true;
      try{
        const btn=document.getElementById("breakBtn");
        btn.disabled=true;
        showToast(localState.isOnBreak?"Ending break...":"Starting break...");

        if(!localState.isWorking){ showToast("⚠️ Punch in first!"); return; }

        if(localState.isOnBreak){
          localState.totalBreakMs+=Date.now()-localState.breakStartTime;
          localState.breakStartTime=null; localState.isOnBreak=false;
        }else{
          localState.breakStartTime=Date.now(); localState.isOnBreak=true;
        }

        stopTickers(); startTickers();

        await Promise.all([writeStateToServer(), logEvent(localState.isOnBreak?"startBreak":"endBreak")]);
        renderUI();
        showToast(localState.isOnBreak?"☕ Break Started":"💼 Break Ended");
      }catch(e){ console.error(e); showToast("⚠️ "+e.message);}
      finally{ document.getElementById("breakBtn").disabled=false; processingBreak=false;}
    }

    document.getElementById("punchBtn").onclick=doPunchToggle;
    document.getElementById("breakBtn").onclick=doBreakToggle;

    // --- Helpers ---
    function getCurrentPositionAsync(){
      return new Promise((res,rej)=>{
        navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true});
      });
    }
    function getDistance(lat1,lon1,lat2,lon2){
      function toRad(x){ return x*Math.PI/180; }
      var R=6371e3; 
      var φ1=toRad(lat1), φ2=toRad(lat2);
      var Δφ=toRad(lat2-lat1), Δλ=toRad(lon2-lon1);
      var a=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);
      var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }

    renderUI();
  </script>
</body>
</html>
