<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA â€” Rider QR Scanner</title>
  <link rel="stylesheet" href="styles.css">

  <!-- QR Scanner library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    .banner { padding:8px; margin:8px 0; border-radius:6px; }
    .success { background:#2d6a4f; color:#fff; }
    .error { background:#9d0208; color:#fff; }
    .info { background:#023e8a; color:#fff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Rider QR Scanner</h1>
    <p class="muted">Scan Scooty or Battery QR to Assign / Return</p>

    <!-- Rider Info -->
    <div id="riderInfo"></div>

    <!-- Scanner -->
    <div id="reader" style="width:300px; margin:auto;"></div>
    <button class="btn secondary" onclick="restartScanner()">ðŸ”„ Restart Scanner</button>

    <!-- Current assignment -->
    <div class="status">
      <h2>Current Assignment</h2>
      <p>Scooty: <span id="currentScooty">None</span></p>
      <p>Battery: <span id="currentBattery">None</span></p>
    </div>

    <!-- Location selector (only for returns) -->
    <div id="locationSection" style="display:none;">
      <label>Select Return Location</label>
      <select id="returnLocation">
        <option value="">-- Select Location --</option>
        <option value="Hub 1">Hub 1</option>
        <option value="Hub 2">Hub 2</option>
        <option value="Hub 3">Hub 3</option>
      </select>
      <button class="btn" onclick="confirmReturn()">Confirm Return</button>
    </div>

    <!-- Logs -->
    <div class="logs">
      <h2>Scan Logs</h2>
      <ul id="logsList"></ul>
    </div>

    <!-- Status Banner -->
    <div id="statusBanner"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentScooty = null;
    let currentBattery = null;
    let lastScanTime = 0;
    let html5QrCode = null;

    let pendingReturn = null; // hold object when rider scans for return

    // ðŸŸ¢ Status banner helper
    function showBanner(msg, type="info") {
      const banner = document.getElementById("statusBanner");
      banner.className = "banner " + type;
      banner.innerText = msg;
      setTimeout(() => { banner.innerText=""; banner.className=""; }, 4000);
    }

    // ðŸŸ¢ Auth guard
    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert("Please sign in first.");
        window.location.href = "rider-signin.html";
        return;
      }
      const email = user.email;
      const doc = await db.collection("users").doc(email).get();
      if (!doc.exists) {
        alert("Rider profile not found.");
        window.location.href = "rider-signup.html";
        return;
      }
      const data = doc.data();
      document.getElementById("riderInfo").innerHTML =
        `<b>${data.name}</b> (${email}) â€” Status: ${data.status}`;
      if (data.status !== "approved") {
        alert("Your account is not approved.");
        window.location.href = "rider-signin.html";
        return;
      }

      // preload assignments + logs
      preloadAssignments(email);
      preloadLogs(email);

      // start scanner
      startScanner();
    });

    // ðŸŸ¢ Preload assignments
    function preloadAssignments(email) {
      // Scooty
      db.collection("scooties").where("assignedTo","==",email)
        .onSnapshot(snap=>{
          if(!snap.empty){
            const d = snap.docs[0];
            currentScooty = d.id;
          } else currentScooty = null;
          updateAssignmentUI();
        });
      // Battery
      db.collection("batteries").where("assignedTo","==",email)
        .onSnapshot(snap=>{
          if(!snap.empty){
            const d = snap.docs[0];
            currentBattery = d.id;
          } else currentBattery = null;
          updateAssignmentUI();
        });
    }

    // ðŸŸ¢ Update UI
    function updateAssignmentUI(){
      document.getElementById("currentScooty").innerText = currentScooty || "None";
      document.getElementById("currentBattery").innerText = currentBattery || "None";
    }

    // ðŸŸ¢ Preload Logs
    function preloadLogs(email){
      db.collection("logs")
        .where("email","==",email)
        .orderBy("timestamp","desc")
        .limit(20)
        .onSnapshot(snap=>{
          const ul = document.getElementById("logsList");
          ul.innerHTML="";
          snap.forEach(doc=>{
            const d = doc.data();
            const li=document.createElement("li");
            li.textContent=`${d.timestamp?.toDate().toLocaleString()||""} â€” ${d.action} ${d.itemType} ${d.itemId} ${d.location||""}`;
            ul.appendChild(li);
          });
        });
    }

    // ðŸŸ¢ Log helper
    async function logAction(email, action, itemId, itemType, location=""){
      await db.collection("logs").add({
        email, action, itemId, itemType, location,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    // ðŸŸ¢ Handle scan
    async function handleScan(qrMessage){
      const now = Date.now();
      if(now - lastScanTime < 3000) return; // debounce
      lastScanTime = now;

      const email = auth.currentUser.email;
      const id = qrMessage.trim();

      let type=null, ref=null;
      if((await db.collection("scooties").doc(id).get()).exists){
        type="scooty"; ref=db.collection("scooties").doc(id);
      } else if((await db.collection("batteries").doc(id).get()).exists){
        type="battery"; ref=db.collection("batteries").doc(id);
      } else {
        showBanner("Unknown QR code: "+id,"error");
        return;
      }

      const snap = await ref.get();
      const data = snap.data();

      // âœ… must be active
      if(data.state !== "active"){
        showBanner(`${type} ${id} is not active.`,"error");
        return;
      }

      // âœ… Assign
      if(data.status==="returned"){
        if(type==="scooty"){
          if(currentScooty){ showBanner("You already have a scooty.","error"); return; }
          await ref.update({status:"assigned", assignedTo:email});
          showBanner(`Scooty ${id} assigned. Scan a battery now.`,"success");
          await logAction(email,"assigned",id,type);
        }
        else if(type==="battery"){
          if(!currentScooty){ showBanner("Scan a scooty first.","error"); return; }
          if(currentBattery){ showBanner("You already have a battery.","error"); return; }
          await ref.update({status:"assigned", assignedTo:email});
          showBanner(`Battery ${id} assigned.`,"success");
          await logAction(email,"assigned",id,type);
        }
      }

      // âœ… Return
      else if(data.status==="assigned" && data.assignedTo===email){
        pendingReturn={ref,id,type,email};
        document.getElementById("locationSection").style.display="block";
        showBanner(`Select location and confirm to return ${type} ${id}.`,"info");
      }
      else{
        showBanner(`${type} ${id} is not eligible.`,"error");
      }
    }

    // ðŸŸ¢ Confirm Return
    async function confirmReturn(){
      if(!pendingReturn){ showBanner("No return in progress.","error"); return; }
      const location=document.getElementById("returnLocation").value;
      if(!location){ showBanner("Select return location.","error"); return; }

      const {ref,id,type,email}=pendingReturn;
      await ref.update({status:"returned", assignedTo:null, location});
      await logAction(email,"returned",id,type,location);

      if(type==="battery") currentBattery=null;
      if(type==="scooty") currentScooty=null;

      updateAssignmentUI();
      showBanner(`${type} ${id} returned.`,"success");
      pendingReturn=null;
      document.getElementById("locationSection").style.display="none";
    }

    // ðŸŸ¢ Start Scanner
    function startScanner(){
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode:"environment" },
        { fps:10, qrbox:250 },
        qrCodeMessage=>handleScan(qrCodeMessage),
        errorMessage=>{ console.log("QR error",errorMessage); }
      ).catch(err=>showBanner("Camera start failed: "+err,"error"));
    }

    // ðŸŸ¢ Restart Scanner
    function restartScanner(){
      if(html5QrCode){
        html5QrCode.stop().then(startScanner);
      } else startScanner();
    }
  </script>
</body>
</html>


