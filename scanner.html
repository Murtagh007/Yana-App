<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — QR Scanner</title>
  <link rel="stylesheet" href="styles.css">

  <!-- QR Scanner -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <div class="card">
    <h1>QR Scanner</h1>
    <p class="muted">Scan a Scooty or Battery QR</p>

    <!-- Scanner -->
    <video id="video" playsinline></video>
    <button class="btn" id="startCam">Open QR Scanner</button>
    <button class="btn" id="stopCam" style="display:none">Stop Camera</button>

    <!-- Pending Action -->
    <div id="pendingSection" style="display:none; margin-top:20px;">
      <h3>Pending Action</h3>
      <p id="pendingText"></p>
      <div id="locationSection" style="display:none; margin:10px 0;">
        <label>Select Return Location:</label>
        <select id="returnLocation">
          <option value="">-- Select Location --</option>
          <option value="Hub 1">Hub 1</option>
          <option value="Hub 2">Hub 2</option>
          <option value="Hub 3">Hub 3</option>
        </select>
      </div>
      <button class="btn" id="confirmBtn">Confirm</button>
      <button class="btn secondary" id="cancelBtn">Cancel</button>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const email = params.get("email");

    if (!email) {
      alert("Not signed in!");
      window.location.href = "rider-signin.html";
    }

    let pendingAction = null;
    let stream = null;
    let scanning = false;
    let scanInterval = null;
    let lastRawResult = null;

    // QR Scan loop
    function scanLoop() {
      const video = document.getElementById("video");
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      scanInterval = setInterval(() => {
        if (!scanning || !video.videoWidth) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);

        if (code && code.data && code.data !== lastRawResult) {
          lastRawResult = code.data;
          console.log("Scanned QR:", code.data);
          handleScan(code.data);
        }
      }, 400);
    }

    async function startCamera() {
      try {
        const video = document.getElementById("video");
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        await video.play();
        scanning = true;
        scanLoop();
        document.getElementById("startCam").style.display = "none";
        document.getElementById("stopCam").style.display = "inline-block";
      } catch (err) {
        console.error("Camera error", err);
        alert("Camera access denied or not available");
      }
    }

    function stopCamera() {
      scanning = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
      document.getElementById("startCam").style.display = "inline-block";
      document.getElementById("stopCam").style.display = "none";
    }

    document.getElementById("startCam").addEventListener("click", startCamera);
    document.getElementById("stopCam").addEventListener("click", stopCamera);

    // Handle scan (assign/return detection only)
    async function handleScan(raw) {
      const id = raw.trim();
      let type = null, ref = null;

      const scootyDoc = await db.collection("scooty_master").doc(id).get();
      const batteryDoc = !scootyDoc.exists ? await db.collection("battery_master").doc(id).get() : null;

      if (scootyDoc.exists) {
        type = "scooty";
        ref = db.collection("scooty_master").doc(id);
      } else if (batteryDoc && batteryDoc.exists) {
        type = "battery";
        ref = db.collection("battery_master").doc(id);
      } else {
        alert("Unknown QR code: " + id);
        return;
      }

      const data = (await ref.get()).data() || {};
      if (data.state !== "active") {
        alert(`${type} ${id} is not active.`);
        return;
      }

      let action = null;
      if (data.status === "returned") {
        action = "assign";
      } else if (data.status === "assigned" && data.assignedTo === email) {
        action = "return";
      } else {
        alert(`${type} ${id} is not eligible for you.`);
        return;
      }

      pendingAction = { action, id, type, ref };
      document.getElementById("pendingText").innerText =
        `${action.toUpperCase()} ${type} ${id}?`;
      document.getElementById("pendingSection").style.display = "block";
      document.getElementById("locationSection").style.display =
        action === "return" ? "block" : "none";
    }

    // Confirm / Cancel
    document.getElementById("confirmBtn").addEventListener("click", async () => {
      if (!pendingAction) return;
      const { action, id, type, ref } = pendingAction;

      try {
        if (action === "assign") {
          await ref.update({
            status: "assigned",
            assignedTo: email,
            location: firebase.firestore.FieldValue.delete()
          });
        } else {
          const location = document.getElementById("returnLocation").value;
          if (!location) { alert("Select return location before returning."); return; }
          await ref.update({
            status: "returned",
            assignedTo: null,
            location
          });
        }

        alert(`✅ ${action.toUpperCase()} complete!`);
        window.location.href = "rider-dashboard.html?email=" + encodeURIComponent(email);
      } catch (e) {
        console.error(e);
        alert("Failed: " + e.message);
      }
    });

    document.getElementById("cancelBtn").addEventListener("click", () => {
      pendingAction = null;
      document.getElementById("pendingSection").style.display = "none";
      document.getElementById("locationSection").style.display = "none";
    });
  </script>
</body>
</html>

