<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Rider QR Scanner</title>
  <link rel="stylesheet" href="styles.css">

  <!-- QR Scanner library -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Your Firebase config (make sure this file exists in same folder) -->
  <script src="firebase-config.js"></script>
</head>
<body>
  <div class="card">
    <h1>Rider QR Scanner</h1>
    <p class="muted">Scan Scooty or Battery QR to Assign / Return</p>

    <!-- Rider Info -->
    <div id="riderInfo"></div>

    <!-- Scanner -->
    <video id="video" playsinline></video>
    <button id="startCam" class="btn">Start Camera</button>
    <button id="stopCam" class="btn" style="display:none">Stop Camera</button>

    <!-- Current assignment -->
    <div class="status">
      <h2>Current Assignment</h2>
      <p>Scooty: <span id="currentScooty">None</span></p>
      <p>Battery: <span id="currentBattery">None</span></p>
    </div>

    <!-- Location selector (only for returns) -->
    <div id="locationSection" style="display:none;">
      <label>Select Return Location</label>
      <select id="returnLocation">
        <option value="">-- Select Location --</option>
        <option value="Hub 1">Hub 1</option>
        <option value="Hub 2">Hub 2</option>
        <option value="Hub 3">Hub 3</option>
      </select>
    </div>

    <!-- Logs -->
    <div class="logs">
      <h2>Scan Logs</h2>
      <ul id="logsList"></ul>
    </div>

    <!-- Pending Action -->
    <div id="pendingSection" style="display:none; margin-top:20px;">
      <h3>Pending Action</h3>
      <p id="pendingText"></p>
      <button class="btn" id="confirmBtn">Confirm</button>
      <button class="btn secondary" id="cancelBtn">Cancel</button>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const email = params.get("email");
    const riderInfoDiv = document.getElementById("riderInfo");

    let currentScooty = null;
    let currentBattery = null;
    let pendingAction = null;

    if(!email){
      alert("Not signed in!");
      window.location.href="rider-signin.html";
    }

    // Load logs for this rider
    function loadLogs() {
      db.collection("logs")
        .where("email", "==", email)
        .orderBy("timestamp", "desc")
        .limit(20)
        .onSnapshot(snapshot => {
          const list = document.getElementById("logsList");
          list.innerHTML = "";
          snapshot.forEach(doc => {
            const d = doc.data();
            const li = document.createElement("li");
            li.textContent = `${d.timestamp?.toDate().toLocaleString()} — ${d.action} ${d.itemType} ${d.itemId} ${d.location || ""}`;
            list.appendChild(li);
          });
        });
    }

    // Load rider info
    async function loadRider() {
      const doc = await db.collection("users").doc(email).get();
      if (!doc.exists) {
        alert("Rider not found.");
        window.location.href = "rider-signup.html";
        return;
      }

      const data = doc.data();
      riderInfoDiv.innerHTML = `<b>${data.name}</b> (${email}) — Status: ${data.status}`;

      if (data.status !== "approved") {
        alert("Your account is not approved.");
        window.location.href = "rider-signin.html";
        return;
      }

      // Load current assignments from Firestore user doc
      currentScooty = data.scooterId || null;
      currentBattery = data.batteryId || null;
      updateAssignmentUI();
    }

    // Update UI
    function updateAssignmentUI(){
      document.getElementById("currentScooty").innerText = currentScooty || "None";
      document.getElementById("currentBattery").innerText = currentBattery || "None";
    }

    // Log helper
    async function logAction(action, itemId, itemType, location=""){
      await db.collection("logs").add({
        email, action, itemId, itemType, location,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      const li = document.createElement("li");
      li.textContent = `${new Date().toLocaleString()} — ${action} ${itemType} ${itemId} ${location}`;
      document.getElementById("logsList").prepend(li);
    }

    // Restore assignments directly from master collections
    async function loadMyAssignments() {
      currentScooty = null;
      currentBattery = null;

      const s = await db.collection("scooty_master")
        .where("assignedTo", "==", email)
        .where("status", "==", "assigned")
        .limit(1).get();
      s.forEach(d => currentScooty = d.id);

      const b = await db.collection("battery_master")
        .where("assignedTo", "==", email)
        .where("status", "==", "assigned")
        .limit(1).get();
      b.forEach(d => currentBattery = d.id);

      updateAssignmentUI();
    }

    // Handle scan
    async function handleScan(raw) {
      const id = raw.trim();
      let type = null, ref = null;

      // Identify collection
      const scootyDoc = await db.collection("scooty_master").doc(id).get();
      const batteryDoc = !scootyDoc.exists
        ? await db.collection("battery_master").doc(id).get()
        : null;

      if (scootyDoc.exists) {
        type = "scooty";
        ref = db.collection("scooty_master").doc(id);
      } else if (batteryDoc && batteryDoc.exists) {
        type = "battery";
        ref = db.collection("battery_master").doc(id);
      } else {
        alert("Unknown QR code: " + id);
        return;
      }

      const snap = await ref.get();
      const data = snap.data() || {};

      if (data.state !== "active") {
        alert(`${type} ${id} is not active.`);
        return;
      }

      let action = null;
      if (data.status === "returned") {
        if (type === "scooty") {
          if (currentScooty && currentScooty !== id) {
            alert("Return your current scooty first.");
            return;
          }
          action = "assign";
        } else {
          if (!currentScooty) {
            alert("Assign a scooty before taking a battery.");
            return;
          }
          if (currentBattery && currentBattery !== id) {
            alert("Return your current battery first.");
            return;
          }
          action = "assign";
        }
      } else if (data.status === "assigned" && data.assignedTo === email) {
        if (type === "scooty" && currentBattery) {
          alert("Return the battery first before returning the scooty.");
          return;
        }
        action = "return";
      } else {
        alert(`${type} ${id} is not eligible for you.`);
        return;
      }

      pendingAction = { action, id, type, ref };
      document.getElementById("pendingText").innerText =
        `${action.toUpperCase()} ${type} ${id}?`;
      document.getElementById("pendingSection").style.display = "block";
      document.getElementById("locationSection").style.display =
        action === "return" ? "block" : "none";
    }

    // Camera start/stop
    let stream = null;
    let scanning = false;
    let scanInterval = null;
    let lastRawResult = null;

    async function startCamera() {
      try {
        const video = document.getElementById("video");
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        video.srcObject = stream;
        await video.play();
        scanning = true;
        scanLoop();
        document.getElementById("startCam").style.display = "none";
        document.getElementById("stopCam").style.display = "inline-block";
      } catch (err) {
        console.error("Camera error", err);
        alert("Camera access denied or not available");
      }
    }

    function stopCamera() {
      scanning = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
      document.getElementById("startCam").style.display = "inline-block";
      document.getElementById("stopCam").style.display = "none";
    }

    function scanLoop() {
      const video = document.getElementById("video");
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      scanInterval = setInterval(() => {
        if (!scanning || !video.videoWidth) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);

        if (code && code.data && code.data !== lastRawResult) {
          lastRawResult = code.data;
          console.log("Scanned QR:", code.data);
          handleScan(code.data);
        }
      }, 400);
    }

    document.getElementById("startCam").addEventListener("click", startCamera);
    document.getElementById("stopCam").addEventListener("click", stopCamera);

    // Confirm / Cancel
    document.getElementById("confirmBtn").addEventListener("click", async () => {
      if (!pendingAction) return;

      const { action, id, type, ref } = pendingAction;

      try {
        if (action === "assign") {
          await ref.update({
            status: "assigned",
            assignedTo: email,
            location: firebase.firestore.FieldValue.delete()
          });
          if (type === "scooty") currentScooty = id; else currentBattery = id;
          await logAction("assigned", id, type);
        } else {
          const location = document.getElementById("returnLocation").value;
          if (!location) { alert("Select return location before returning."); return; }

          await ref.update({
            status: "returned",
            assignedTo: null,
            location
          });
          if (type === "scooty") currentScooty = null; else currentBattery = null;
          await logAction("returned", id, type, location);
        }

        // Keep user doc synced
        await db.collection("users").doc(email).update({
          scooterId: currentScooty || null,
          batteryId: currentBattery || null
        });

        updateAssignmentUI();
      } catch (e) {
        console.error(e);
        alert("Failed to update: " + e.message);
      } finally {
        pendingAction = null;
        document.getElementById("pendingSection").style.display = "none";
        document.getElementById("locationSection").style.display = "none";
      }
    });

    document.getElementById("cancelBtn").addEventListener("click", () => {
      pendingAction = null;
      document.getElementById("pendingSection").style.display = "none";
      document.getElementById("locationSection").style.display = "none";
    });

    // Run on page load
    (async () => {
      await loadRider();
      await loadMyAssignments();
      loadLogs();
    })();
  </script>
</body>
</html>
