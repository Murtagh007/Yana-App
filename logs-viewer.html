<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Logs Viewer</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background-color: #3498db; /* Dashboard blue */
      color: #fff; /* White text */
    }
    .filters {
      margin: 15px 0;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    input[type="text"], input[type="date"] {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .btn.small {
      padding: 6px 12px;
      font-size: 13px;
    }
    .pagination {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }
    .pagination button {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
      cursor: pointer;
    }
    .pagination button.active {
      background: var(--action);
      color: #000;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <button class="btn secondary" onclick="window.location.href='admin-dashboard.html'">⬅ Dashboard</button>
    <span class="profile-pic">A</span>
  </div>

  <div class="container">
    <h1>📜 Logs Viewer</h1>
    <p class="muted">View all state changes, status changes, and issue resolutions.</p>

    <div class="filters">
      <label>Filter: </label>
      <select id="logFilter">
        <option value="all">All</option>
        <option value="state-change">State-Change</option>
        <option value="status-change">Status-Change</option>
        <option value="issue-resolved">Issue-Resolution</option>
      </select>

      <label>Start Date: </label>
      <input type="date" id="startDate">

      <label>End Date: </label>
      <input type="date" id="endDate">

      <label>Search by Asset ID: </label>
      <input type="text" id="searchInput" placeholder="e.g. SCOOTY002"/>

      <button class="btn small" id="exportBtn">⬇ Export CSV</button>
    </div>

    <table id="logsTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Action Type</th>
          <th>Item Type</th>
          <th>Item ID</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const tbody = document.querySelector("#logsTable tbody");
    const pagination = document.getElementById("pagination");
    let allLogs = [];
    let currentPage = 1;
    const pageSize = 10;

    // Normalize function: first letters uppercase
    function normalize(str) {
      return str ? str.split(" ").map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" ") : "-";
    }

    // Auth check
    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = "admin-signin.html";

      const doc = await db.collection("users").doc(user.email).get();
      if (!doc.exists || doc.data().role !== "admin") {
        alert("❌ Not an admin.");
        return location.href = "index.html";
      }

      loadLogs();
    });

    function loadLogs() {
      db.collection("logs").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        allLogs = snapshot.docs.map(d => {
          const data = d.data();
          let userName = "-";
          if(data.admin || data.email){
            let emailOrAdmin = data.admin || data.email;
            userName = normalize(emailOrAdmin.split("@")[0].replace(/[._]/g," "));
          }

          let actionType = "";
          let details = "";
          if(data.action === "state-change") {
            actionType = "State-Change";
            details = normalize(data.newState || data.state);
          } else if(data.action === "assigned" || data.action==="returned") {
            actionType = "Status-Change";
            details = normalize(data.action === "assigned" ? "Assigned" : "Returned");
          } else if(data.action==="issue-resolved" || data.action==="issue-created") {
            actionType = "Issue-Resolution";
            details = normalize(data.issue || data.status || "");
          }

          return {
            time: data.timestamp?.toDate().toLocaleString() || "-",
            user: userName,
            actionType: actionType,
            itemType: data.itemType || (data.type==="scooty_master"?"Scooty":"Battery"),
            itemId: data.itemId || data.assetId,
            details: details
          };
        });

        currentPage = 1;
        renderPage();
      });
    }

    function getFilteredLogs() {
      const filter = document.getElementById("logFilter").value;
      const searchText = document.getElementById("searchInput").value.trim().toLowerCase();
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      return allLogs.filter(log => {
        if(filter!=="all" && log.actionType.toLowerCase() !== filter) return false;
        if(searchText && !log.itemId.toLowerCase().includes(searchText)) return false;
        if(startDate && new Date(log.time) < new Date(startDate)) return false;
        if(endDate && new Date(log.time) > new Date(endDate)) return false;
        return true;
      });
    }

    function renderPage() {
      const logs = getFilteredLogs();
      const totalPages = Math.ceil(logs.length/pageSize);
      const start = (currentPage-1)*pageSize;
      const end = start+pageSize;

      tbody.innerHTML = "";
      logs.slice(start,end).forEach(log => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${log.time}</td>
          <td>${log.user}</td>
          <td>${log.actionType}</td>
          <td>${log.itemType}</td>
          <td>${log.itemId}</td>
          <td>${log.details}</td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(totalPages);
    }

    function renderPagination(totalPages){
      pagination.innerHTML = "";
      for(let i=1;i<=totalPages;i++){
        const btn = document.createElement("button");
        btn.innerText = i;
        if(i===currentPage) btn.classList.add("active");
        btn.addEventListener("click",()=>{ currentPage=i; renderPage(); });
        pagination.appendChild(btn);
      }
    }

    // Filter events
    document.getElementById("logFilter").addEventListener("change",()=>{ currentPage=1; renderPage(); });
    document.getElementById("searchInput").addEventListener("input",()=>{ currentPage=1; renderPage(); });
    document.getElementById("startDate").addEventListener("change",()=>{ currentPage=1; renderPage(); });
    document.getElementById("endDate").addEventListener("change",()=>{ currentPage=1; renderPage(); });

    // Export CSV
    document.getElementById("exportBtn").addEventListener("click",()=>{
      const logs = getFilteredLogs();
      if(!logs.length){ alert("⚠️ No logs to export."); return; }

      const headers = ["Time","User","Action Type","Item Type","Item ID","Details"];
      const rows = logs.map(log => [log.time, log.user, log.actionType, log.itemType, log.itemId, log.details]);

      let csvContent = "data:text/csv;charset=utf-8," 
        + headers.join(",") + "\n"
        + rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");

      const link=document.createElement("a");
      link.setAttribute("href",encodeURI(csvContent));
      link.setAttribute("download","logs_export.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
