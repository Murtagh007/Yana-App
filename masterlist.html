<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Scooty & Battery Masterlist</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* Tabs */
    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .tab {
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      transition: var(--transition);
    }
    .tab.active {
      background: var(--action);
      color: #000;
      border-color: var(--action);
    }

    /* Card layout */
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      transition: var(--transition);
    }
    .card:hover {
      border-color: var(--action);
      box-shadow: 0 0 10px var(--action);
    }
    .card-left {
      flex: 1;
      min-width: 150px;
    }
    .card-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    select {
      padding: 4px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
    }
    #searchBar {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      padding: 8px 12px;
      border-radius: var(--radius);
      margin-bottom: 12px;
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <h2>⚡ YANA Admin</h2>
    <div class="profile">
      <div class="profile-pic">A</div>
      <div class="dropdown">
        <button onclick="location.href='admin-dashboard.html'">⬅ Dashboard</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>Scooty & Battery Masterlist</h2>
    <p class="muted">View and manage state/status of assets. Changes apply immediately.</p>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-type="scooty">Scooties</div>
      <div class="tab" data-type="battery">Batteries</div>
    </div>

    <!-- Search bar -->
    <input type="text" id="searchBar" placeholder="Search by ID or assigned user">

    <!-- Cards container -->
    <div id="cardsContainer"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const cardsContainer = document.getElementById("cardsContainer");
    const tabs = document.querySelectorAll(".tab");
    let allAssets = { scooty: [], battery: [] };
    let currentTab = "scooty";

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href="admin-signin.html";
      document.querySelector(".profile-pic").innerText = (user.email[0]||"A").toUpperCase();

      const doc = await db.collection("users").doc(user.email).get();
      if (!doc.exists || doc.data().role !== "admin") {
        alert("❌ Not an admin.");
        return location.href="index.html";
      }

      loadAssets("scooty_master", "scooty");
      loadAssets("battery_master", "battery");
    });

    document.getElementById("logoutBtn").onclick = () => auth.signOut();

    function loadAssets(collectionName, type) {
      db.collection(collectionName).onSnapshot(snapshot => {
        allAssets[type] = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          data.collection = collectionName;
          allAssets[type].push(data);
        });
        if (currentTab === type) renderCards();
      });
    }

    function renderCards() {
      const list = allAssets[currentTab];
      const term = document.getElementById("searchBar").value.toLowerCase();
      cardsContainer.innerHTML = "";
      list.filter(a => a.id.toLowerCase().includes(term) || (a.assignedTo||"").toLowerCase().includes(term))
          .forEach(a => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-left">
            <b>${a.id}</b><br>
            Assigned To: ${a.assignedTo||"-"}
          </div>
          <div class="card-right">
            <select data-id="${a.id}" data-col="${a.collection}" data-field="state">
              <option value="active" ${a.state==="active"?"selected":""}>Active</option>
              <option value="repair" ${a.state==="repair"?"selected":""}>Repair</option>
              <option value="maintenance" ${a.state==="maintenance"?"selected":""}>Maintenance</option>
              <option value="dead" ${a.state==="dead"?"selected":""}>Dead</option>
            </select>
            <select data-id="${a.id}" data-col="${a.collection}" data-field="status">
              <option value="returned" ${a.status==="returned"?"selected":""}>Returned</option>
              <option value="assigned" ${a.status==="assigned"?"selected":""}>Assigned</option>
            </select>
          </div>
        `;
        cardsContainer.appendChild(card);
      });
    }

    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        currentTab = tab.dataset.type;
        renderCards();
      });
    });

    // Search filter
    document.getElementById("searchBar").addEventListener("input", renderCards);

    // Update on dropdown change
    document.addEventListener("change", async e => {
      if (e.target.tagName==="SELECT" && e.target.dataset.id) {
        const col = e.target.dataset.col;
        const id = e.target.dataset.id;
        const field = e.target.dataset.field;
        const value = e.target.value;
        try {
          await db.collection(col).doc(id).update({ [field]: value });
        } catch(err) {
          console.error("Update failed", err);
          alert("❌ Failed to update " + col);
        }
      }
    });
  </script>
</body>
</html>
