<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA ‚Äî Manage Locations</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <h2>üìç Manage Locations</h2>
    <div class="profile">
      <div class="profile-pic">A</div>
      <div class="dropdown">
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>Add New Location</h2>
    <form id="locationForm" class="panel" style="padding:1rem;">
      <input type="text" id="locName" placeholder="Location Name" class="input"/>
      <input type="number" id="locLat" placeholder="Latitude" step="any" class="input"/>
      <input type="number" id="locLng" placeholder="Longitude" step="any" class="input"/>
      <input type="number" id="locRadius" placeholder="Radius (meters)" class="input"/>
      <button type="submit" class="menu-btn ripple" style="margin-top:1rem;">‚ûï Save Location</button>
    </form>

    <h2 style="margin-top:2rem;">Saved Locations</h2>
    <div id="locationsList" class="panel" style="padding:1rem;">
      <p>Loading...</p>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    // Ensure only admins can access
    auth.onAuthStateChanged(async user => {
      if (!user) return location.href="admin-signin.html";
      const doc = await db.collection("users").doc(user.email).get();
      if (!doc.exists || doc.data().role !== "admin") {
        alert("‚ùå Not an admin."); return location.href="index.html";
      }
    });

    document.getElementById("logoutBtn").onclick = () => auth.signOut();

    // Add new location
    document.getElementById("locationForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("locName").value.trim();
      const lat = parseFloat(document.getElementById("locLat").value);
      const lng = parseFloat(document.getElementById("locLng").value);
      const radius = parseInt(document.getElementById("locRadius").value);

      if (!name || isNaN(lat) || isNaN(lng) || isNaN(radius)) {
        alert("‚ö†Ô∏è Please fill all fields correctly.");
        return;
      }

      await db.collection("locations").add({
        name, lat, lng, radius,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      document.getElementById("locationForm").reset();
    });

    // Load and render locations
    function loadLocations() {
      db.collection("locations").orderBy("createdAt","desc").onSnapshot(snap => {
        const list = document.getElementById("locationsList");
        if (snap.empty) {
          list.innerHTML = "<p>No locations added yet.</p>";
          return;
        }

        list.innerHTML = snap.docs.map(doc => {
          const d = doc.data();
          return `
            <div class="chip" style="margin:0.3rem 0; display:flex; justify-content:space-between; align-items:center;">
              <span><b>${d.name}</b> ‚Äî [${d.lat}, ${d.lng}] ‚Äî ${d.radius}m</span>
              <div style="display:flex; gap:0.3rem;">
                <button onclick="editLocation('${doc.id}', '${d.name}', ${d.lat}, ${d.lng}, ${d.radius})" 
                        class="menu-btn" style="padding:0.2rem 0.5rem; font-size:0.8rem; background:#2980b9; color:white;">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteLocation('${doc.id}')" 
                        class="menu-btn" style="padding:0.2rem 0.5rem; font-size:0.8rem; background:#c0392b; color:white;">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `;
        }).join("");
      });
    }
    loadLocations();

    // Delete a location
    async function deleteLocation(id) {
      if (confirm("Delete this location?")) {
        await db.collection("locations").doc(id).delete();
      }
    }

    // Edit a location
    async function editLocation(id, name, lat, lng, radius) {
      const newName = prompt("Location Name:", name);
      if (!newName) return;

      const newLat = parseFloat(prompt("Latitude:", lat));
      if (isNaN(newLat)) return alert("Invalid latitude");

      const newLng = parseFloat(prompt("Longitude:", lng));
      if (isNaN(newLng)) return alert("Invalid longitude");

      const newRadius = parseInt(prompt("Radius (meters):", radius));
      if (isNaN(newRadius)) return alert("Invalid radius");

      await db.collection("locations").doc(id).update({
        name: newName,
        lat: newLat,
        lng: newLng,
        radius: newRadius,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  </script>
</body>
</html>
